local ai_army_setups = {
	-- first rift opening
	{
		{ -- 12500
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_daemonette_0",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_cav_hellstriders_0",
			"wh3_main_sla_veh_seeker_chariot_0",
			"wh3_main_sla_inf_chaos_furies_0",
			"wh3_main_sla_inf_chaos_furies_0",
			"wh3_main_sla_inf_chaos_furies_0",
			"wh3_main_sla_inf_chaos_furies_0",
			"wh3_main_sla_mon_spawn_of_slaanesh_0",
			"wh3_main_sla_mon_spawn_of_slaanesh_0"
		},
		{
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_1",
			"wh3_main_sla_inf_daemonette_0",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_cav_hellstriders_0",
			"wh3_main_sla_cav_hellstriders_1",
			"wh3_main_sla_cav_heartseekers_of_slaanesh_0",
			"wh3_main_sla_inf_chaos_furies_0",
			"wh3_main_sla_inf_chaos_furies_0",
			"wh3_main_sla_mon_spawn_of_slaanesh_0",
			"wh3_main_sla_mon_spawn_of_slaanesh_0"
		}
	},
	-- second rift opening
	{
		{ -- 17500
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_1",
			"wh3_main_sla_inf_marauders_2",
			"wh3_main_sla_inf_marauders_2",
			"wh3_main_sla_cav_hellstriders_1",
			"wh3_main_sla_cav_hellstriders_1",
			"wh3_main_sla_veh_seeker_chariot_0",
			"wh3_main_sla_inf_chaos_furies_0",
			"wh3_main_sla_mon_spawn_of_slaanesh_0",
			"wh3_main_sla_mon_fiends_of_slaanesh_0",
			"wh3_main_sla_mon_fiends_of_slaanesh_0",
			"wh3_main_sla_mon_soul_grinder_0",
			"wh3_main_sla_mon_keeper_of_secrets_0"
		},
		{
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_1",
			"wh3_main_sla_inf_marauders_1",
			"wh3_main_sla_inf_marauders_2",
			"wh3_main_sla_inf_marauders_2",
			"wh3_main_sla_inf_marauders_2",
			"wh3_main_sla_inf_daemonette_0",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_cav_hellstriders_0",
			"wh3_main_sla_cav_hellstriders_0",
			"wh3_main_sla_cav_hellstriders_0",
			"wh3_main_sla_cav_hellstriders_1",
			"wh3_main_sla_veh_seeker_chariot_0",
			"wh3_main_sla_veh_hellflayer_0",
			"wh3_main_sla_cav_heartseekers_of_slaanesh_0",
			"wh3_main_sla_mon_spawn_of_slaanesh_0",
			"wh3_main_sla_mon_soul_grinder_0"
		},
	},
	-- third rift opening
	{
		{ -- 22500
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_2",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_cav_hellstriders_1",
			"wh3_main_sla_veh_seeker_chariot_0",
			"wh3_main_sla_cav_seekers_of_slaanesh_0",
			"wh3_main_sla_veh_exalted_seeker_chariot_0",
			"wh3_main_sla_mon_spawn_of_slaanesh_0",
			"wh3_main_sla_mon_soul_grinder_0",
			"wh3_main_sla_mon_keeper_of_secrets_0",
			"wh3_main_sla_mon_keeper_of_secrets_0",
			"wh3_main_sla_mon_keeper_of_secrets_0"
		},
		{
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_0",
			"wh3_main_sla_inf_marauders_1",
			"wh3_main_sla_inf_marauders_2",
			"wh3_main_sla_inf_daemonette_0",
			"wh3_main_sla_inf_daemonette_0",
			"wh3_main_sla_inf_daemonette_0",
			"wh3_main_sla_inf_daemonette_0",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_cav_hellstriders_0",
			"wh3_main_sla_cav_seekers_of_slaanesh_0",
			"wh3_main_sla_cav_heartseekers_of_slaanesh_0",
			"wh3_main_sla_cav_heartseekers_of_slaanesh_0",
			"wh3_main_sla_cav_heartseekers_of_slaanesh_0",
			"wh3_main_sla_veh_exalted_seeker_chariot_0",
			"wh3_main_sla_veh_exalted_seeker_chariot_0",
			"wh3_main_sla_mon_fiends_of_slaanesh_0",
			"wh3_main_sla_mon_keeper_of_secrets_0"
		}
	},
	-- fourth+ rift opening
	{
		{ -- 27500
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_veh_hellflayer_0",
			"wh3_main_sla_veh_hellflayer_0",
			"wh3_main_sla_veh_hellflayer_0",
			"wh3_main_sla_cav_heartseekers_of_slaanesh_0",
			"wh3_main_sla_cav_heartseekers_of_slaanesh_0",
			"wh3_main_sla_veh_exalted_seeker_chariot_0",
			"wh3_main_sla_veh_exalted_seeker_chariot_0",
			"wh3_main_sla_veh_exalted_seeker_chariot_0",
			"wh3_main_sla_inf_chaos_furies_0",
			"wh3_main_sla_mon_soul_grinder_0",
			"wh3_main_sla_mon_keeper_of_secrets_0"
		},
		{
			"wh3_main_sla_inf_marauders_1",
			"wh3_main_sla_inf_daemonette_0",
			"wh3_main_sla_inf_daemonette_0",
			"wh3_main_sla_inf_daemonette_0",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_inf_daemonette_1",
			"wh3_main_sla_cav_heartseekers_of_slaanesh_0",
			"wh3_main_sla_cav_heartseekers_of_slaanesh_0",
			"wh3_main_sla_veh_exalted_seeker_chariot_0",
			"wh3_main_sla_veh_exalted_seeker_chariot_0",
			"wh3_main_sla_inf_chaos_furies_0",
			"wh3_main_sla_mon_spawn_of_slaanesh_0",
			"wh3_main_sla_mon_soul_grinder_0",
			"wh3_main_sla_mon_soul_grinder_0",
			"wh3_main_sla_mon_soul_grinder_0",
			"wh3_main_sla_mon_keeper_of_secrets_0",
			"wh3_main_sla_mon_keeper_of_secrets_0"
		}
	}
};

local patrol_routes = {
	["first_circle"] = {{x = 746, y = 682}, {x = 810, y = 627}, {x = 746, y = 572}, {x = 681, y = 627}},
	["second_circle"] = {{x = 746, y = 674}, {x = 800, y = 627}, {x = 746, y = 580}, {x = 691, y = 627}},
	["third_circle"] = {{x = 746, y = 665}, {x = 790, y = 627}, {x = 746, y = 589}, {x = 701, y = 627}},
	["fourth_circle"] = {{x = 746, y = 656}, {x = 780, y = 627}, {x = 746, y = 598}, {x = 711, y = 627}},
	["fifth_circle"] = {{x = 746, y = 648}, {x = 771, y = 627}, {x = 746, y = 606}, {x = 721, y = 627}},
	["sixth_circle"] = {{x = 746, y = 639}, {x = 760, y = 627}, {x = 746, y = 615}, {x = 731, y = 627}}
};

local creep_armies = {
	["slaanesh_start"] = {
		{"first_circle_inv_1", "", {748, 682}, patrol_routes.first_circle, "wh3_main_sla_rapturous_excess"},
		{"first_circle_inv_2", "", {748, 570}, patrol_routes.first_circle, "wh3_main_sla_rapturous_excess"}
	},
	
	["slaanesh_first"] = {
		{"second_circle_inv_1", "", {700, 602}, patrol_routes.second_circle, "wh3_main_sla_rapturous_excess"},
		{"second_circle_inv_2", "", {771, 668}, patrol_routes.second_circle, "wh3_main_sla_rapturous_excess"}
	},
	
	["slaanesh_second"] = {
		{"third_circle_inv_1", "", {713, 652}, patrol_routes.third_circle, "wh3_main_sla_rapturous_excess"},
		{"third_circle_inv_2", "", {780, 605}, patrol_routes.third_circle, "wh3_main_sla_rapturous_excess"}
	},
	
	["slaanesh_third"] = {
		{"fourth_circle_inv_1", "", {747, 656}, patrol_routes.fourth_circle, "wh3_main_sla_rapturous_excess"},
		{"fourth_circle_inv_2", "", {747, 599}, patrol_routes.fourth_circle, "wh3_main_sla_rapturous_excess"}
	},
	
	["slaanesh_fourth"] = {
		{"fifth_circle_inv_1", "", {723, 635}, patrol_routes.fifth_circle, "wh3_main_sla_rapturous_excess"},
		{"fifth_circle_inv_2", "", {767, 617}, patrol_routes.fifth_circle, "wh3_main_sla_rapturous_excess"}
	},
	
	["slaanesh_fifth"] = {
		{"sixth_circle_inv_1", "", {753, 617}, patrol_routes.sixth_circle, "wh3_main_sla_rapturous_excess"}
	}
};

local gates = {
	-- gate/area trigger, location to teleport to
	["slaanesh_start_01"] = {
		{714, 680, 717, 674}
	},
	["slaanesh_start_02"] = {
		{769, 684, 766, 679}
	},
	["slaanesh_start_03"] = {
		{807, 656, 801, 654}
	},
	["slaanesh_start_04"] = {
		{810, 606, 805, 609}
	},
	["slaanesh_start_05"] = {
		{777, 574, 774, 579}
	},
	["slaanesh_start_06"] = {
		{721, 570, 723, 576}
	},
	["slaanesh_start_07"] = {
		{683, 599, 689, 602}
	},
	["slaanesh_start_08"] = {
		{680, 648, 686, 646}
	},
	["slaanesh_first"] = {
		{786, 666, 782, 662}, -- 45
		{793, 592, 787, 596}, -- 135
		{703, 588, 709, 592}, -- 225
		{701, 662, 706, 659} -- 315
	},
	["slaanesh_second"] = {
		{744, 672, 746, 665}, -- 0
		{798, 631, 790, 630}, -- 90
		{752, 582, 750, 589}, -- 180
		{693, 622, 702, 625} -- 270
	},
	["slaanesh_third"] = {
		{772, 655, 769, 649}, -- 45
		{777, 604, 772, 608}, -- 135
		{719, 600, 723, 604}, -- 225
		{716, 651, 720, 647} -- 315
	},
	["slaanesh_fourth"] = {
		{778, 629, 771, 628}, -- 90
		{714, 625, 721, 625} -- 270
	},
	["slaanesh_fifth"] = {
		{745, 645, 746, 639}, -- 0
		{748, 608, 747, 614} -- 180
	},
	["slaanesh_sixth"] = {
		{757, 628, 751, 627}, -- 90
		{735, 626, 741, 627} -- 270
	}
};

local final_pos = {746, 625};

local vfx = {
	{"slaanesh_start", "scripted_effect21"},
	{"slaanesh_first", "scripted_effect22"},
	{"slaanesh_second", "scripted_effect23"},
	{"slaanesh_third", "scripted_effect24"},
	{"slaanesh_fourth", "scripted_effect25"},
	{"slaanesh_fifth", "scripted_effect26"}
};

local slaanesh_realm_initialised = false;

function setup_realm_slaanesh(entering_faction)
	if entering_faction and entering_faction:is_human() then
		attempt_to_trigger_realm_final_battle_pre_cindyscene(entering_faction:name(), "slaanesh");
	end;
	
	if not slaanesh_realm_initialised then
		cm:remove_hex_area_trigger("slaanesh_end");
		cm:add_hex_area_trigger("slaanesh_end", final_pos[1], final_pos[2], 3);
		
		cm:callback(
			function()
				for i = 1, #vfx do
					if not cm:get_saved_value(vfx[i][1] .. "_circle_initialised") then
						cm:add_vfx(vfx[i][1], vfx[i][2], 498, 484, 0);
					end;
				end;
			end,
			0.1
		);
		
		local slaanesh_dilemma_active = false;
		
		-- set up area entered listeners for each gate
		for circle_id, circle_coord_set in pairs(gates) do
			for i = 1, #circle_coord_set do
				local current_coords = circle_coord_set[i];
				local current_id = circle_id .. "_" .. i;
				
				local display_pos_x, display_pos_y = cm:log_to_dis(current_coords[1], current_coords[2]);
				
				cm:draw_line(display_pos_x, display_pos_y, 0, display_pos_x, display_pos_y, 10, 9999);
				
				cm:remove_interactable_campaign_marker(current_id);
				cm:add_interactable_campaign_marker(current_id, "wh3_main_sla_portal", current_coords[1], current_coords[2], 3);
				
				core:add_listener(
					current_id,
					"AreaEntered",
					function(context)
						local character = context:family_member():character();
						if not character:is_null_interface() then
							return not cm:model():pending_battle():is_active() and not slaanesh_dilemma_active and context:area_key() == current_id and character:region_data():key():ends_with(circle_id) and not character:faction():pooled_resource_manager():resource("wh3_main_realm_complete_khorne"):is_null_interface() and cm:char_is_general_with_army(character);
						end;
					end,
					function(context)
						local family_member = context:family_member();
						local character = family_member:character();
						if character:is_null_interface() then
							return;
						end;

						local char_str = cm:char_lookup_str(character);
						local faction = character:faction();
						local faction_name = faction:name();
						
						out.chaos("Entered gate [" .. context:area_key() .. "]");
						
						local function teleport_through_gate()
							local final_x, final_y = cm:find_valid_spawn_location_for_character_from_position(faction_name, current_coords[3], current_coords[4], false);
							
							out.chaos("\tCalculating teleport destination: " .. current_coords[3] .. ", " .. current_coords[4] .. " -> " .. final_x .. ", " .. final_y);
							
							if final_x ~= -1 then
								local text_pos_x, text_pos_y = cm:log_to_dis(final_x, final_y);
								cm:draw_text("Teleporting...", text_pos_x, text_pos_y, 15, 2, 0, 255, 255);
								
								out.chaos("Teleporting to " .. final_x .. ", " .. final_y);
								
								local circle_to_initialise = circle_id;
								
								if circle_to_initialise:find("slaanesh_start") then
									circle_to_initialise = "slaanesh_start";
								end;
								
								if not cm:get_saved_value(circle_to_initialise .. "_circle_initialised") then
									initialise_newly_entered_circle(faction_name, circle_to_initialise);
								end;
								
								common.trigger_soundevent("Campaign_Structure_Stance_Sla_Portal_Teleport");
								
								cm:teleport_to(char_str, final_x, final_y);
								cm:zero_action_points(char_str);
							else
								script_error("Couldn't find position");
							end;
						end;
						
						local character_is_starting = character:region_data():key():starts_with("wh3_main_chaos_region_slaanesh_start_");
						
						if character_is_starting then
							teleport_through_gate();
						elseif faction:is_human() then
							out.chaos("Triggering dilemma wh3_main_realm_" .. circle_id);
							
							cm:set_saved_value("slaanesh_realm_dilemma_payload_unit_rank", false);
							cm:set_saved_value("slaanesh_realm_dilemma_payload_character_rank", false);
							
							local circle_dilemma = cm:create_dilemma_builder("wh3_main_realm_" .. circle_id .. "_" .. cm:random_number(2));
							local circle_dilemma_payload_first = cm:create_payload();
							local slaanesh_realm_dilemma_payload_index = cm:get_saved_value("slaanesh_realm_dilemma_payload_index") or {cm:random_number(2), cm:random_number(3), cm:random_number(4), cm:random_number(5), cm:random_number(6)};
							
							if circle_id == "slaanesh_first" then
								
								circle_dilemma_payload_first:treasury_adjustment(15000);
								circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "common"));
								circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "common"));
								circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "common"));
								circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "common"));
								circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "uncommon"));
								
							elseif circle_id == "slaanesh_second" then
								
								local index = slaanesh_realm_dilemma_payload_index[1];
								
								local effect_bundle = cm:create_new_custom_effect_bundle("wh3_main_bundle_slaanesh_realm_left_second");
								effect_bundle:set_duration(15);
								
								if index == 1 then
									circle_dilemma_payload_first:treasury_adjustment(20000);
									effect_bundle:add_effect("wh2_dlc17_effect_force_all_campaign_replenishment_rate_horde", "faction_to_character_own_factionwide_armytext", 200);
									effect_bundle:add_effect("wh_main_effect_province_growth_other", "faction_to_province_own", 200);
									effect_bundle:add_effect("wh_main_ignore_replenishment_cap", "faction_to_faction_own_unseen", 100);
									circle_dilemma_payload_first:effect_bundle_to_faction(effect_bundle);
								else
									circle_dilemma_payload_first:treasury_adjustment(40000);
									effect_bundle:add_effect("wh2_dlc17_effect_force_all_campaign_replenishment_rate_horde", "faction_to_character_own_factionwide_armytext", 100);
									effect_bundle:add_effect("wh_main_effect_province_growth_other", "faction_to_province_own", 100);
									effect_bundle:add_effect("wh_main_ignore_replenishment_cap", "faction_to_faction_own_unseen", 100);
									circle_dilemma_payload_first:effect_bundle_to_faction(effect_bundle);
								end;
								
							elseif circle_id == "slaanesh_third" then
								
								local index = slaanesh_realm_dilemma_payload_index[2];
								
								local effect_bundle = cm:create_new_custom_effect_bundle("wh3_main_bundle_slaanesh_realm_left_third");
								effect_bundle:set_duration(20);
								
								if index == 1 then
									circle_dilemma_payload_first:treasury_adjustment(25000);
									effect_bundle:add_effect("wh_main_effect_public_order_events", "faction_to_province_own", 200);
									effect_bundle:add_effect("wh_main_faction_political_diplomacy_mod", "faction_to_faction_own_unseen", 20);
									circle_dilemma_payload_first:effect_bundle_to_faction(effect_bundle);
								elseif index == 2 then
									circle_dilemma_payload_first:treasury_adjustment(50000);
									effect_bundle:add_effect("wh_main_faction_political_diplomacy_mod", "faction_to_faction_own_unseen", 20);
									circle_dilemma_payload_first:effect_bundle_to_faction(effect_bundle);
								else
									circle_dilemma_payload_first:treasury_adjustment(25000);
									effect_bundle:add_effect("wh_main_effect_public_order_events", "faction_to_province_own", 200);
									circle_dilemma_payload_first:effect_bundle_to_faction(effect_bundle);
								end;
								
							elseif circle_id == "slaanesh_fourth" then
								
								local index = slaanesh_realm_dilemma_payload_index[3];
								
								local effect_bundle = cm:create_new_custom_effect_bundle("wh3_main_bundle_slaanesh_realm_left_fourth");
								effect_bundle:set_duration(5);
								
								if index == 1 then
									circle_dilemma_payload_first:treasury_adjustment(30000);
									effect_bundle:add_effect("wh_dlc05_effect_global_recruitment_duration_all", "faction_to_faction_own_unseen", -1);
									effect_bundle:add_effect("wh_main_effect_force_all_campaign_recruitment_cost", "faction_to_force_own_unseen", -80);
									circle_dilemma_payload_first:effect_bundle_to_faction(effect_bundle);
									cm:set_saved_value("slaanesh_realm_dilemma_payload_unit_rank", 9);
									circle_dilemma_payload_first:text_display("dummy_wh3_main_realm_slaanesh_fourth_9");
								elseif index == 2 then
									circle_dilemma_payload_first:treasury_adjustment(60000);
									effect_bundle:add_effect("wh_main_effect_force_all_campaign_recruitment_cost", "faction_to_force_own_unseen", -80);
									circle_dilemma_payload_first:effect_bundle_to_faction(effect_bundle);
									cm:set_saved_value("slaanesh_realm_dilemma_payload_unit_rank", 4);
									circle_dilemma_payload_first:text_display("dummy_wh3_main_realm_slaanesh_fourth_4");
								elseif index == 3 then
									circle_dilemma_payload_first:treasury_adjustment(30000);
									effect_bundle:add_effect("wh_main_effect_force_all_campaign_experience_base_all", "faction_to_character_own_factionwide_armytext", 4);
									circle_dilemma_payload_first:effect_bundle_to_faction(effect_bundle);
									cm:set_saved_value("slaanesh_realm_dilemma_payload_unit_rank", 4);
									circle_dilemma_payload_first:text_display("dummy_wh3_main_realm_slaanesh_fourth_4");
								else
									effect_bundle:set_duration(0);
									effect_bundle:add_effect("wh_dlc05_effect_global_recruitment_duration_all", "faction_to_faction_own_unseen", -1);
									circle_dilemma_payload_first:effect_bundle_to_faction(effect_bundle);
									circle_dilemma_payload_first:treasury_adjustment(60000);
									cm:set_saved_value("slaanesh_realm_dilemma_payload_unit_rank", 9);
									circle_dilemma_payload_first:text_display("dummy_wh3_main_realm_slaanesh_fourth_9");
								end;
								
							elseif circle_id == "slaanesh_fifth" then
								
								local index = slaanesh_realm_dilemma_payload_index[4];
								
								local effect_bundle = cm:create_new_custom_effect_bundle("wh3_main_bundle_slaanesh_realm_left_fifth");
								effect_bundle:set_duration(10);
								
								if index == 1 then
									circle_dilemma_payload_first:treasury_adjustment(45000);
									if not faction:ancillary_exists("wh3_main_anc_follower_the_dark_princes_paramour") then
										remove_slaanesh_ancillary("wh3_main_anc_follower_the_dark_princes_paramour");
										circle_dilemma_payload_first:character_ancillary_gain(character, "wh3_main_anc_follower_the_dark_princes_paramour", true);
									end;
									cm:set_saved_value("slaanesh_realm_dilemma_payload_character_rank", 5);
									circle_dilemma_payload_first:text_display("dummy_wh3_main_realm_slaanesh_fifth_5");
								elseif index == 2 then
									circle_dilemma_payload_first:treasury_adjustment(90000);
									if not faction:ancillary_exists("wh3_main_anc_follower_the_dark_princes_paramour") then
										remove_slaanesh_ancillary("wh3_main_anc_follower_the_dark_princes_paramour");
										circle_dilemma_payload_first:character_ancillary_gain(character, "wh3_main_anc_follower_the_dark_princes_paramour", true);
									end;
								elseif index == 3 then
									circle_dilemma_payload_first:treasury_adjustment(45000);
									effect_bundle:add_effect("wh2_main_effect_agent_recruitment_xp_all_agents_and_lords", "faction_to_province_own", 10);
									circle_dilemma_payload_first:effect_bundle_to_faction(effect_bundle);
									cm:set_saved_value("slaanesh_realm_dilemma_payload_character_rank", 10);
									circle_dilemma_payload_first:text_display("dummy_wh3_main_realm_slaanesh_fifth_10");
								elseif index == 4 then
									circle_dilemma_payload_first:treasury_adjustment(45000);
									effect_bundle:add_effect("wh2_main_effect_agent_recruitment_xp_all_agents_and_lords", "faction_to_province_own", 5);
									circle_dilemma_payload_first:effect_bundle_to_faction(effect_bundle);
									cm:set_saved_value("slaanesh_realm_dilemma_payload_character_rank", 15);
									circle_dilemma_payload_first:text_display("dummy_wh3_main_realm_slaanesh_fifth_15");
								else
									circle_dilemma_payload_first:treasury_adjustment(45000);
									effect_bundle:add_effect("wh2_main_effect_agent_recruitment_xp_all_agents_and_lords", "faction_to_province_own", 20);
									circle_dilemma_payload_first:effect_bundle_to_faction(effect_bundle);
									cm:set_saved_value("slaanesh_realm_dilemma_payload_character_rank", 5);
									circle_dilemma_payload_first:text_display("dummy_wh3_main_realm_slaanesh_fifth_5");
								end;
								
							elseif circle_id == "slaanesh_sixth" then
								
								local index = slaanesh_realm_dilemma_payload_index[5];
								
								if index == 1 then
									circle_dilemma_payload_first:treasury_adjustment(50000);
									if not faction:ancillary_exists("wh3_main_anc_weapon_slaaneshs_blade") then
										remove_slaanesh_ancillary("wh3_main_anc_weapon_slaaneshs_blade");
										circle_dilemma_payload_first:character_ancillary_gain(character, "wh3_main_anc_weapon_slaaneshs_blade", true);
									end;
									if not faction:ancillary_exists("wh3_main_anc_follower_personal_sycophant") then
										remove_slaanesh_ancillary("wh3_main_anc_follower_personal_sycophant");
										circle_dilemma_payload_first:character_ancillary_gain(character, "wh3_main_anc_follower_personal_sycophant", true);
									end;
								elseif index == 2 then
									circle_dilemma_payload_first:treasury_adjustment(100000);
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "uncommon"));
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "uncommon"));
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "uncommon"));
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "rare"));
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "rare"));
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "rare"));
								elseif index == 3 then
									circle_dilemma_payload_first:treasury_adjustment(75000);
									if not faction:ancillary_exists("wh3_main_anc_weapon_slaaneshs_blade") then
										remove_slaanesh_ancillary("wh3_main_anc_weapon_slaaneshs_blade");
										circle_dilemma_payload_first:character_ancillary_gain(character, "wh3_main_anc_weapon_slaaneshs_blade", true);
									end;
								elseif index == 4 then
									circle_dilemma_payload_first:treasury_adjustment(75000);
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "uncommon"));
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "uncommon"));
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "uncommon"));
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "uncommon"));
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "rare"));
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "rare"));
									if not faction:ancillary_exists("wh3_main_anc_follower_personal_sycophant") then
										remove_slaanesh_ancillary("wh3_main_anc_follower_personal_sycophant");
										circle_dilemma_payload_first:character_ancillary_gain(character, "wh3_main_anc_follower_personal_sycophant", true);
									end;
								elseif index == 5 then
									circle_dilemma_payload_first:treasury_adjustment(75000);
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "uncommon"));
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "uncommon"));
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "rare"));
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "rare"));
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "rare"));
									circle_dilemma_payload_first:faction_ancillary_gain(faction, get_random_ancillary_key_for_faction(faction_name, false, "rare"));
								else
									circle_dilemma_payload_first:treasury_adjustment(50000);
								end;
								
							end;
							
							circle_dilemma_payload_first:text_display("dummy_wh3_main_leave_slaanesh_realm");
							
							local circle_dilemma_payload_second = cm:create_payload();
							circle_dilemma_payload_second:components_from_record("wh3_main_slaanesh_realm_dilemma_empty", faction, faction);
							
							circle_dilemma:add_choice_payload("FIRST", circle_dilemma_payload_first);
							circle_dilemma:add_choice_payload("SECOND", circle_dilemma_payload_second);
							
							circle_dilemma:add_target("default", family_member);
							circle_dilemma:add_target("default", faction);
							
							cm:launch_custom_dilemma_from_builder(circle_dilemma, faction);
							
							slaanesh_dilemma_active = true;
							
							core:add_listener(
								circle_id .. "_dilemma_choice",
								"DilemmaChoiceMadeEvent",
								function(context)
									return context:dilemma():starts_with("wh3_main_realm_" .. circle_id);
								end,
								function(context)
									slaanesh_dilemma_active = false;
									
									if context:choice() == 1 then
										teleport_through_gate();
										
										-- as a safeguard, attempt issue the quest battle mission again in case it's missing
										if circle_id == "slaanesh_sixth" then
											trigger_realm_final_battle(faction_name, "slaanesh");
										end;
									else
										-- apply scripted payloads from dilemmas
										local unit_rank = cm:get_saved_value("slaanesh_realm_dilemma_payload_unit_rank");
										
										if unit_rank then
											cm:add_experience_to_units_commanded_by_character(char_str, unit_rank);
										end;
										
										local character_rank = cm:get_saved_value("slaanesh_realm_dilemma_payload_character_rank");
										
										if character_rank then
											local character_list = faction:character_list();
											
											for j = 0, character_list:num_items() - 1 do
												local current_character = character_list:item_at(j);
												if not current_character:character_type("colonel") then
													local current_character_rank = current_character:rank();
													local xp = cm.character_xp_per_level[math.min(current_character_rank + character_rank, 50)] - cm.character_xp_per_level[current_character_rank];
													
													if xp > 0 then
														cm:add_agent_experience(cm:char_lookup_str(current_character), xp);
													end;
												end;
											end;
										end;
										
										cm:set_saved_value("slaanesh_realm_dilemma_payload_unit_rank", false);
										cm:set_saved_value("slaanesh_realm_dilemma_payload_character_rank", false);
										
										leave_circle(character, circle_id);
									end;
								end,
								false
							);
						else
							local leading_faction = cm:get_saved_value("slaanesh_realm_leading_faction") or {faction_name, circle_id};
							
							-- leave the realm if the ai faction is either not in the lead, or has already completed the realm (with a 50% chance)
							if ((leading_faction[1] ~= faction_name and is_faction_in_realm(cm:get_faction(leading_faction[1]), "slaanesh")) or faction:pooled_resource_manager():resource("wh3_main_realm_complete_slaanesh"):value() >= 1) and cm:random_number(2) == 1 then
								leave_circle(character, circle_id);
							else
								teleport_through_gate();
							end;
						end;
					end,
					true
				);
			end;
		end;
		
		setup_ai_behaviour(
			function(context)
				local faction = context:faction();
				local faction_name = faction:name();
				local character = faction:faction_leader();
				
				local x = character:logical_position_x();
				local y = character:logical_position_y();
				
				local character_region = character:region_data():key()
				local circle_coord_set = nil;
				
				if character_region:ends_with("slaanesh_start_01") then
					circle_coord_set = gates.slaanesh_start_01;
				elseif character_region:ends_with("slaanesh_start_02") then
					circle_coord_set = gates.slaanesh_start_02;
				elseif character_region:ends_with("slaanesh_start_03") then
					circle_coord_set = gates.slaanesh_start_03;
				elseif character_region:ends_with("slaanesh_start_04") then
					circle_coord_set = gates.slaanesh_start_04;
				elseif character_region:ends_with("slaanesh_start_05") then
					circle_coord_set = gates.slaanesh_start_05;
				elseif character_region:ends_with("slaanesh_start_06") then
					circle_coord_set = gates.slaanesh_start_06;
				elseif character_region:ends_with("slaanesh_start_07") then
					circle_coord_set = gates.slaanesh_start_07;
				elseif character_region:ends_with("slaanesh_start_08") then
					circle_coord_set = gates.slaanesh_start_08;
				elseif character_region:ends_with("slaanesh_first") then
					circle_coord_set = gates.slaanesh_first;
				elseif character_region:ends_with("slaanesh_second") then
					circle_coord_set = gates.slaanesh_second;
				elseif character_region:ends_with("slaanesh_third") then
					circle_coord_set = gates.slaanesh_third;
				elseif character_region:ends_with("slaanesh_fourth") then
					circle_coord_set = gates.slaanesh_fourth;
				elseif character_region:ends_with("slaanesh_fifth") then
					circle_coord_set = gates.slaanesh_fifth;
				elseif character_region:ends_with("slaanesh_sixth") then
					circle_coord_set = gates.slaanesh_sixth;
				end;
				
				out.chaos("Circle: " .. character_region);
				
				local closest_distance = 500000;
				local desired_position = {};
				
				if circle_coord_set then
					for i = 1, #circle_coord_set do
						local current_distance = distance_squared(x, y, circle_coord_set[i][1], circle_coord_set[i][2]);
						
						if current_distance < closest_distance then
							closest_distance = current_distance;
							desired_position.x = circle_coord_set[i][1];
							desired_position.y = circle_coord_set[i][2];
						end;
					end;
				else
					desired_position.x = final_pos[1];
					desired_position.y = final_pos[2];
				end;
				
				if desired_position.x then
					if find_target_and_attack(character, true, closest_distance) then
						core:add_listener(
							"target_attacked_slaanesh_realm",
							"BattleCompleted",
							true,
							function()
								-- Delay this, otherwise move is discarded - don't pass in character reference as it might expire in the interval
								cm:callback(function() attempt_to_move_realm_character_to_desired_location(faction_name, nil, desired_position) end, 0.2);
							end,
							false
						);
					else
						attempt_to_move_realm_character_to_desired_location(faction_name, character, desired_position);
					end;
				end;
			end,
			"slaanesh"
		);
		
		core:add_listener(
			"ai_reaches_end_of_slaanesh_realm",
			"AreaEntered",
			function(context)
				local character = context:family_member():character();
				if not character:is_null_interface() then
					local faction = character:faction();
					return context:area_key() == "slaanesh_end" and not faction:is_human() and not faction:pooled_resource_manager():resource("wh3_main_realm_complete_khorne"):is_null_interface() and cm:char_is_general_with_army(character) and can_ai_army_complete_final_battle(character:military_force());
				end;
			end,
			function(context)
				close_realm(context:family_member():character_details():faction():name(), "slaanesh");
			end,
			false
		);
		
		core:add_listener(
			"player_loses_slaanesh_survival_battle",
			"BattleCompleted",
			function()
				local pb = cm:model():pending_battle();
				return pb:set_piece_battle_key():find("wh3_main_survival_slaanesh_") and pb:has_been_fought() and not cm:pending_battle_cache_human_victory() and pb:has_defender();
			end,
			function()
				local defender = cm:model():pending_battle():defender();
				local faction_cqi = defender:faction():command_queue_index();
				
				cm:trigger_dilemma_with_targets(faction_cqi, "wh3_main_realm_slaanesh_final_battle", faction_cqi, 0, defender:command_queue_index(), 0, 0, 0, nil, false);
				
				core:add_listener(
					"player_loses_slaanesh_survival_battle_dilemma_choice",
					"DilemmaChoiceMadeEvent",
					function(context)
						return context:dilemma() == "wh3_main_realm_slaanesh_final_battle";
					end,
					function(context)
						slaanesh_dilemma_active = false;
						
						if context:choice() == 0 then
							leave_circle(defender);
						end;
					end,
					false
				);
			end,
			true
		);
	end;
	
	-- listeners have been established, only set them up again if a save is loaded
	slaanesh_realm_initialised = true;
	
	if entering_faction then
		if entering_faction:is_human() then
			cm:set_saved_value("slaanesh_realm_dilemma_payload_index", {cm:random_number(2), cm:random_number(3), cm:random_number(4), cm:random_number(5), cm:random_number(6)});
		else
			toggle_faction_leader_ai(entering_faction, false);
		end;
	end;
	
	cm:set_saved_value("slaanesh_realm_active", true);
end;

function remove_slaanesh_ancillary(ancillary_key)
	local faction_list = cm:model():world():faction_list();
	
	for i = 0, faction_list:num_items() - 1 do
		local current_faction = faction_list:item_at(i);
		
		if current_faction:ancillary_exists(ancillary_key) then
			cm:force_remove_ancillary_from_faction(current_faction, ancillary_key);
		end;
	end;
end;

function leave_circle(character, circle_id)
	out.chaos("Leaving...");
	
	local faction = character:faction();
	local faction_name = faction:name();
	local char_lookup_str = cm:char_lookup_str(character:command_queue_index());
	
	if circle_id then
		cm:force_add_trait(char_lookup_str, "wh3_main_trait_sla_left_" .. circle_id, true);
	end;
	
	-- do not allow this faction to teleport into the realms again for another 15 turns
	cm:faction_add_pooled_resource(faction_name, "wh3_main_enter_realm_cost", "other", -faction:pooled_resource_manager():resource("wh3_main_enter_realm_cost"):value());
	cm:add_turn_countdown_event(faction_name, rifts_duration, "ScriptEventSlaaneshRealmCooldownExpires", faction_name);
	
	cm:set_saved_value("slaanesh_realm_offer_taken_" .. faction_name, true);
	common.set_context_value("slaanesh_realm_offer_taken_" .. faction_name, 1);
	
	-- return the character to the point they teleported from
	local cached_x, cached_y, x, y = teleport_characters_out_of_realm(faction, "slaanesh", true);
	
	-- find the rift by the coords we cached...
	local open_rifts = cm:model():world():teleportation_network_system():lookup_network("wh3_main_teleportation_network_chaos"):open_nodes();
	
	for i = 0, open_rifts:num_items() - 1 do
		local current_rift = open_rifts:item_at(i);
		local current_rift_pos_x, current_rift_pos_y = current_rift:position();
		
		if current_rift_pos_x == cached_x and current_rift_pos_y == cached_y then
			cm:teleportation_network_close_node(current_rift:record_key());
			break;
		end
	end;
	
	-- update ui
	common.set_context_value(faction_name .. "_is_in_realm", "");
	cm:set_saved_value(faction_name .. "_is_in_realm", "");
	
	if faction:is_human() then
		-- cancel the survival battle mission
		local battle_key_to_cancel = "wh3_main_survival_slaanesh_" .. faction:faction_leader():character_subtype_key();
		
		cm:cancel_custom_mission(faction_name, battle_key_to_cancel);
		cm:cancel_custom_mission(faction_name, battle_key_to_cancel .. "_easy");
		cm:cancel_custom_mission(faction_name, battle_key_to_cancel .. "_hard");
		
		local camera_x, camera_y = cm:log_to_dis(x, y);
		local cached_x, cached_y, cached_d, cached_b, cached_h = cm:get_camera_position();
		cm:scroll_camera_from_current(false, 1, {camera_x, camera_y, cached_d, cached_b, cached_h});
	else
		toggle_faction_leader_ai(faction, true);
	end;
end;

function initialise_newly_entered_circle(faction_name, id)
	cm:remove_vfx(id);
	
	-- deploy creep armies
	if creep_armies[id] then
		setup_creep_army_comp(creep_armies[id], ai_army_setups);
		deploy_creep_armies(creep_armies[id], true, -1);
		
		cm:set_saved_value(id .. "_circle_initialised", true);
	end;
	
	-- track which faction is closest to the end
	local leading_faction = cm:get_saved_value("slaanesh_realm_leading_faction") or {faction_name, id};
	
	local circle_mapping = {
		["slaanesh_first"] = 1,
		["slaanesh_second"] = 2,
		["slaanesh_third"] = 3,
		["slaanesh_fourth"] = 4,
		["slaanesh_fifth"] = 5,
		["slaanesh_sixth"] = 6
	};
	
	if circle_mapping[id] and (leading_faction[1] == faction_name or circle_mapping[id] > circle_mapping[leading_faction[2]] or not is_faction_in_realm(cm:get_faction(leading_faction[1]), "slaanesh")) then
		cm:set_saved_value("slaanesh_realm_leading_faction", {faction_name, id});
	end;
end;

function close_slaanesh_realm()
	for creep_army_id, creep_army_data in pairs(creep_armies) do
		kill_realm_armies(creep_army_data);
	end;
	
	slaanesh_realm_initialised = false;
	
	for i = 1, #vfx do
		cm:remove_vfx(vfx[i][1]);
		cm:set_saved_value(vfx[i][1] .. "_circle_initialised", false);
	end;
	
	cm:remove_hex_area_trigger("slaanesh_end");
	
	for circle_id, circle_coord_set in pairs(gates) do
		for i = 1, #circle_coord_set do
			core:remove_listener(circle_id .. "_" .. i);
			cm:remove_interactable_campaign_marker(circle_id .. "_" .. i);
		end;
	end;
	
	core:remove_listener("ai_reaches_end_of_slaanesh_realm");
	core:remove_listener("player_loses_slaanesh_survival_battle");
	core:remove_listener("target_attacked_slaanesh_realm");
	
	cm:set_saved_value("slaanesh_realm_leading_faction", false);
	cm:set_saved_value("slaanesh_realm_dilemma_payload_index", false);
	cm:set_saved_value("slaanesh_realm_active", false);
end;