local wh3_main_kho_brazen_throne_setup = {
	-- first rift opening
	{
		{
			"wh3_main_kho_inf_chaos_warriors_0",
			"wh3_main_kho_inf_chaos_warriors_0",
			"wh3_main_kho_inf_bloodletters_0",
			"wh3_main_kho_inf_bloodletters_0",
			"wh3_main_kho_inf_chaos_warriors_2",
			"wh3_main_kho_cav_bloodcrushers_0",
			"wh3_main_kho_cav_bloodcrushers_0",
			"wh3_main_kho_inf_chaos_warhounds_0",
			"wh3_main_kho_inf_chaos_warhounds_0",
			"wh3_main_kho_inf_chaos_warhounds_0",
			"wh3_main_kho_mon_spawn_of_khorne_0",
			"wh3_main_kho_mon_spawn_of_khorne_0"
		}
	},
	-- second rift opening
	{
		{
			"wh3_main_kho_inf_chaos_warriors_0",
			"wh3_main_kho_inf_bloodletters_0",
			"wh3_main_kho_inf_bloodletters_0",
			"wh3_main_kho_inf_bloodletters_0",
			"wh3_main_kho_inf_chaos_warriors_1",
			"wh3_main_kho_inf_chaos_warriors_1",
			"wh3_main_kho_inf_chaos_warriors_2",
			"wh3_main_kho_cav_bloodcrushers_0",
			"wh3_main_kho_cav_bloodcrushers_0",
			"wh3_main_kho_cav_skullcrushers_0",
			"wh3_main_kho_cav_skullcrushers_0",
			"wh3_main_kho_inf_chaos_warhounds_0",
			"wh3_main_kho_inf_flesh_hounds_of_khorne_0",
			"wh3_main_kho_mon_spawn_of_khorne_0",
			"wh3_main_kho_mon_spawn_of_khorne_0"
		}
	},
	-- third rift opening
	{
		{
			"wh3_main_kho_inf_chaos_warriors_0",
			"wh3_main_kho_inf_bloodletters_0",
			"wh3_main_kho_inf_chaos_warriors_1",
			"wh3_main_kho_inf_bloodletters_1",
			"wh3_main_kho_inf_bloodletters_1",
			"wh3_main_kho_inf_bloodletters_1",
			"wh3_main_kho_inf_bloodletters_1",
			"wh3_main_kho_cav_gorebeast_chariot",
			"wh3_main_kho_cav_bloodcrushers_0",
			"wh3_main_kho_inf_chaos_warhounds_0",
			"wh3_main_kho_inf_chaos_warhounds_0",
			"wh3_main_kho_mon_khornataurs_0",
			"wh3_main_kho_mon_soul_grinder_0",
			"wh3_main_kho_mon_bloodthirster_0",
			"wh3_main_kho_mon_bloodthirster_0",
			"wh3_main_kho_veh_blood_shrine_0",
			"wh3_main_kho_veh_blood_shrine_0"
		}
	},
	-- fourth+ rift opening
	{
		{
			"wh3_main_kho_inf_chaos_warriors_0",
			"wh3_main_kho_inf_bloodletters_0",
			"wh3_main_kho_inf_bloodletters_0",
			"wh3_main_kho_inf_chaos_warriors_1",
			"wh3_main_kho_inf_chaos_warriors_1",
			"wh3_main_kho_inf_bloodletters_1",
			"wh3_main_kho_inf_bloodletters_1",
			"wh3_main_kho_inf_bloodletters_1",
			"wh3_main_kho_cav_gorebeast_chariot",
			"wh3_main_kho_cav_gorebeast_chariot",
			"wh3_main_kho_cav_bloodcrushers_0",
			"wh3_main_kho_cav_skullcrushers_0",
			"wh3_main_kho_inf_chaos_warhounds_0",
			"wh3_main_kho_mon_khornataurs_0",
			"wh3_main_kho_mon_khornataurs_1",
			"wh3_main_kho_mon_khornataurs_1",
			"wh3_main_kho_mon_soul_grinder_0",
			"wh3_main_kho_mon_bloodthirster_0",
			"wh3_main_kho_veh_skullcannon_0"
		}
	}
};

local wh2_main_rogue_wrath_of_nature_setup = {
	-- first rift opening
	{
		{
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_forest_dragon_0"
		}
	},
	-- second rift opening
	{
		{
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_forest_dragon_0",
			"wh_dlc05_wef_forest_dragon_0"
		}
	},
	-- third rift opening
	{
		{
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_forest_dragon_0",
			"wh_dlc05_wef_forest_dragon_0",
			"wh_dlc05_wef_forest_dragon_0"
		}
	},
	-- fourth+ rift opening
	{
		{
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_inf_dryads_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_mon_treekin_0",
			"wh_dlc05_wef_forest_dragon_0",
			"wh_dlc05_wef_forest_dragon_0",
			"wh_dlc05_wef_forest_dragon_0",
			"wh_dlc05_wef_forest_dragon_0",
			"wh_dlc05_wef_forest_dragon_0"
		}
	}
};

local wh2_main_rogue_the_wandering_dead_setup = {
	-- first rift opening
	{
		{
			"wh_main_vmp_inf_zombie",
			"wh_main_vmp_inf_zombie",
			"wh_main_vmp_inf_zombie",
			"wh_main_vmp_inf_zombie",
			"wh_main_vmp_inf_skeleton_warriors_0",
			"wh_main_vmp_inf_skeleton_warriors_0",
			"wh_main_vmp_inf_skeleton_warriors_1",
			"wh_main_vmp_inf_skeleton_warriors_1",
			"wh_main_vmp_inf_skeleton_warriors_1",
			"wh_main_vmp_inf_cairn_wraiths",
			"wh_main_vmp_inf_cairn_wraiths",
			"wh_main_vmp_inf_cairn_wraiths",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_main_vmp_inf_crypt_ghouls"
		}
	},
	-- second rift opening
	{
		{
			"wh_main_vmp_inf_zombie",
			"wh_main_vmp_inf_zombie",
			"wh_main_vmp_inf_zombie",
			"wh_main_vmp_inf_zombie",
			"wh_main_vmp_inf_zombie",
			"wh_main_vmp_inf_skeleton_warriors_0",
			"wh_main_vmp_inf_skeleton_warriors_0",
			"wh_main_vmp_inf_skeleton_warriors_1",
			"wh_main_vmp_inf_skeleton_warriors_1",
			"wh_main_vmp_inf_skeleton_warriors_1",
			"wh_main_vmp_inf_skeleton_warriors_1",
			"wh_main_vmp_inf_cairn_wraiths",
			"wh_main_vmp_inf_cairn_wraiths",
			"wh_main_vmp_inf_cairn_wraiths",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_main_vmp_inf_crypt_ghouls"
		}
	},
	-- third rift opening
	{
		{
			"wh_main_vmp_inf_zombie",
			"wh_main_vmp_inf_zombie",
			"wh_main_vmp_inf_zombie",
			"wh_main_vmp_inf_zombie",
			"wh_main_vmp_inf_zombie",
			"wh_main_vmp_inf_skeleton_warriors_0",
			"wh_main_vmp_inf_skeleton_warriors_0",
			"wh_main_vmp_inf_skeleton_warriors_1",
			"wh_main_vmp_inf_skeleton_warriors_1",
			"wh_main_vmp_inf_skeleton_warriors_1",
			"wh_main_vmp_inf_skeleton_warriors_1",
			"wh_main_vmp_inf_cairn_wraiths",
			"wh_main_vmp_inf_cairn_wraiths",
			"wh_main_vmp_inf_cairn_wraiths",
			"wh_main_vmp_inf_cairn_wraiths",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_main_vmp_inf_crypt_ghouls"
		}
	},
	-- fourth+ rift opening
	{
		{
			"wh_main_vmp_inf_zombie",
			"wh_main_vmp_inf_zombie",
			"wh_main_vmp_inf_zombie",
			"wh_main_vmp_inf_skeleton_warriors_0",
			"wh_main_vmp_inf_skeleton_warriors_0",
			"wh_main_vmp_inf_skeleton_warriors_0",
			"wh_main_vmp_inf_skeleton_warriors_1",
			"wh_main_vmp_inf_skeleton_warriors_1",
			"wh_main_vmp_inf_skeleton_warriors_1",
			"wh_main_vmp_inf_skeleton_warriors_1",
			"wh_main_vmp_inf_cairn_wraiths",
			"wh_main_vmp_inf_cairn_wraiths",
			"wh_main_vmp_inf_cairn_wraiths",
			"wh_main_vmp_inf_cairn_wraiths",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_main_vmp_inf_crypt_ghouls"
		}
	}
};

local wh2_main_rogue_abominations_setup = {
	-- first rift opening
	{
		{
			"wh2_main_skv_mon_hell_pit_abomination",
			"wh_dlc03_bst_inf_cygor_0",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_dlc03_bst_mon_chaos_spawn_0",
			"wh_dlc03_bst_mon_chaos_spawn_0",
			"wh_main_vmp_mon_crypt_horrors",
			"wh_main_vmp_mon_crypt_horrors",
			"wh2_main_skv_mon_rat_ogres",
			"wh_dlc03_bst_inf_razorgor_herd_0",
			"wh_dlc03_bst_inf_razorgor_herd_0"
		}
	},
	-- second rift opening
	{
		{
			"wh2_main_skv_mon_hell_pit_abomination",
			"wh2_main_skv_mon_hell_pit_abomination",
			"wh_dlc03_bst_inf_cygor_0",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_dlc03_bst_mon_chaos_spawn_0",
			"wh_dlc03_bst_mon_chaos_spawn_0",
			"wh_main_vmp_mon_crypt_horrors",
			"wh_main_vmp_mon_crypt_horrors",
			"wh2_main_skv_mon_rat_ogres",
			"wh2_main_skv_mon_rat_ogres",
			"wh_dlc03_bst_inf_razorgor_herd_0",
			"wh_dlc03_bst_inf_razorgor_herd_0"
		}
	},
	-- third rift opening
	{
		{
			"wh2_main_skv_mon_hell_pit_abomination",
			"wh2_main_skv_mon_hell_pit_abomination",
			"wh_dlc03_bst_inf_cygor_0",
			"wh_dlc03_bst_inf_cygor_0",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_dlc03_bst_mon_chaos_spawn_0",
			"wh_dlc03_bst_mon_chaos_spawn_0",
			"wh_dlc03_bst_mon_chaos_spawn_0",
			"wh_main_vmp_mon_crypt_horrors",
			"wh_main_vmp_mon_crypt_horrors",
			"wh2_main_skv_mon_rat_ogres",
			"wh2_main_skv_mon_rat_ogres",
			"wh_dlc03_bst_inf_razorgor_herd_0",
			"wh_dlc03_bst_inf_razorgor_herd_0"
		}
	},
	-- fourth+ rift opening
	{
		{
			"wh2_main_skv_mon_hell_pit_abomination",
			"wh2_main_skv_mon_hell_pit_abomination",
			"wh2_main_skv_mon_hell_pit_abomination",
			"wh_dlc03_bst_inf_cygor_0",
			"wh_dlc03_bst_inf_cygor_0",
			"wh_dlc03_bst_inf_cygor_0",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_main_vmp_inf_crypt_ghouls",
			"wh_dlc03_bst_mon_chaos_spawn_0",
			"wh_dlc03_bst_mon_chaos_spawn_0",
			"wh_dlc03_bst_mon_chaos_spawn_0",
			"wh_main_vmp_mon_crypt_horrors",
			"wh_main_vmp_mon_crypt_horrors",
			"wh2_main_skv_mon_rat_ogres",
			"wh2_main_skv_mon_rat_ogres",
			"wh_dlc03_bst_inf_razorgor_herd_0",
			"wh_dlc03_bst_inf_razorgor_herd_0"
		}
	}
};

local wh2_main_rogue_beastcatchas_setup = {
	-- first rift opening
	{
		{
			"wh2_main_def_mon_war_hydra",
			"wh2_main_def_mon_war_hydra",
			"wh_dlc06_grn_inf_squig_herd_0",
			"wh_dlc06_grn_inf_squig_herd_0",
			"wh_dlc06_grn_inf_squig_herd_0",
			"wh_dlc06_grn_inf_squig_herd_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh2_main_lzd_mon_carnosaur_0",
			"wh2_main_lzd_mon_carnosaur_0"
		}
	},
	-- second rift opening
	{
		{
			"wh2_main_def_mon_war_hydra",
			"wh2_main_def_mon_war_hydra",
			"wh_dlc06_grn_inf_squig_herd_0",
			"wh_dlc06_grn_inf_squig_herd_0",
			"wh_dlc06_grn_inf_squig_herd_0",
			"wh_dlc06_grn_inf_squig_herd_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh2_main_lzd_mon_carnosaur_0",
			"wh2_main_lzd_mon_carnosaur_0",
			"wh2_main_lzd_mon_carnosaur_0"
		}
	},
	-- third rift opening
	{
		{
			"wh2_main_def_mon_war_hydra",
			"wh2_main_def_mon_war_hydra",
			"wh2_main_def_mon_war_hydra",
			"wh_dlc06_grn_inf_squig_herd_0",
			"wh_dlc06_grn_inf_squig_herd_0",
			"wh_dlc06_grn_inf_squig_herd_0",
			"wh_dlc06_grn_inf_squig_herd_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh2_main_lzd_mon_carnosaur_0",
			"wh2_main_lzd_mon_carnosaur_0",
			"wh2_main_lzd_mon_carnosaur_0"
		}
	},
	-- fourth+ rift opening
	{
		{
			"wh2_main_def_mon_war_hydra",
			"wh2_main_def_mon_war_hydra",
			"wh2_main_def_mon_war_hydra",
			"wh2_main_def_mon_war_hydra",
			"wh_dlc06_grn_inf_squig_herd_0",
			"wh_dlc06_grn_inf_squig_herd_0",
			"wh_dlc06_grn_inf_squig_herd_0",
			"wh_dlc06_grn_inf_squig_herd_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh_dlc06_grn_cav_squig_hoppers_0",
			"wh2_main_lzd_mon_carnosaur_0",
			"wh2_main_lzd_mon_carnosaur_0",
			"wh2_main_lzd_mon_carnosaur_0",
			"wh2_main_lzd_mon_carnosaur_0"
		}
	}
};

local wh2_main_rogue_celestial_storm_setup = {
	-- first rift opening
	{
		{
			"wh_dlc01_chs_mon_dragon_ogre",
			"wh_dlc01_chs_mon_dragon_ogre",
			"wh_dlc01_chs_mon_dragon_ogre",
			"wh_dlc01_chs_mon_dragon_ogre_shaggoth",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1"
		}
	},
	-- second rift opening
	{
		{
			"wh_dlc01_chs_mon_dragon_ogre",
			"wh_dlc01_chs_mon_dragon_ogre",
			"wh_dlc01_chs_mon_dragon_ogre",
			"wh_dlc01_chs_mon_dragon_ogre",
			"wh_dlc01_chs_mon_dragon_ogre_shaggoth",
			"wh_dlc01_chs_mon_dragon_ogre_shaggoth",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1"
		}
	},
	-- third rift opening
	{
		{
			"wh_dlc01_chs_mon_dragon_ogre",
			"wh_dlc01_chs_mon_dragon_ogre",
			"wh_dlc01_chs_mon_dragon_ogre",
			"wh_dlc01_chs_mon_dragon_ogre",
			"wh_dlc01_chs_mon_dragon_ogre",
			"wh_dlc01_chs_mon_dragon_ogre_shaggoth",
			"wh_dlc01_chs_mon_dragon_ogre_shaggoth",
			"wh_dlc01_chs_mon_dragon_ogre_shaggoth",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1"
		}
	},
	-- fourth+ rift opening
	{
		{
			"wh_dlc01_chs_mon_dragon_ogre",
			"wh_dlc01_chs_mon_dragon_ogre",
			"wh_dlc01_chs_mon_dragon_ogre",
			"wh_dlc01_chs_mon_dragon_ogre",
			"wh_dlc01_chs_mon_dragon_ogre",
			"wh_dlc01_chs_mon_dragon_ogre_shaggoth",
			"wh_dlc01_chs_mon_dragon_ogre_shaggoth",
			"wh_dlc01_chs_mon_dragon_ogre_shaggoth",
			"wh_dlc01_chs_mon_dragon_ogre_shaggoth",
			"wh_dlc01_chs_mon_dragon_ogre_shaggoth",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1",
			"wh2_main_lzd_inf_saurus_spearmen_1"
		}
	}
};

local creep_armies = {
	{
		"khorne_inv_1",
		"",
		{535, 695},
		{{x = 555, y = 677}, {x = 610, y = 677}},
		"wh2_main_rogue_wrath_of_nature",
		{"wh_dlc05_wef_ancient_treeman", "names_name_2147352825"}
	},
	{
		"khorne_inv_2",
		"",
		{598, 686},
		{{x = 575, y = 677}, {x = 520, y = 677}},
		"wh2_main_rogue_the_wandering_dead",
		{"wh_main_vmp_master_necromancer", "names_name_2147357583"}
	},
	{
		"khorne_inv_3",
		"",
		{552, 668},
		{{x = 575, y = 677}, {x = 520, y = 677}},
		"wh2_main_rogue_abominations",
		{"wh_dlc03_bst_beastlord", "names_name_2147358506"}
	},
	{
		"khorne_inv_4",
		"",
		{577, 668},
		{{x = 575, y = 677}, {x = 520, y = 677}},
		"wh2_main_rogue_beastcatchas",
		{"wh_main_grn_goblin_great_shaman", "names_name_2147344966"}
	},
	{
		"khorne_inv_5",
		"",
		{523, 664},
		{{x = 575, y = 677}, {x = 520, y = 677}},
		"wh2_main_rogue_celestial_storm",
		{"wh2_main_lzd_saurus_old_blood", "names_name_2049506471"}
	},
	{
		"khorne_inv_6",
		"",
		{595, 665},
		{{x = 575, y = 677}, {x = 520, y = 677}},
		"wh3_main_kho_brazen_throne"
	}
};

-- amount of bloodshed required, looked up by the number of ursuns roars
local points_required = {
	300000,
	400000,
	500000,
	600000
};

local current_points_required = 0;

khorne_realm_encounters = {
	["wh3_main_kho_machina_daemonium"] =		{619, 657, "wh3_main_anc_weapon_gilellions_soulnetter"},
	["wh3_main_kho_skull_of_the_first"] =		{517, 705, "wh3_main_anc_weapon_skars_kraken_killer"},
	["wh3_main_kho_tree_of_souls"] =			{612, 686, "wh3_main_anc_weapon_the_bane_spear"},
	["wh3_main_kho_wrathgate"] =				{521, 657, "wh3_main_anc_weapon_chainsword"}
};

local final_pos = {564, 668};

local khorne_realm_initialised = false;

-- Issue the Khorne Realm mission. This may be called from within this script, or by the narrative scripts.
function issue_khorne_realm_mission(faction_key, is_from_narrative_event)
	local mm = mission_manager:new(faction_key, "wh3_main_khorne_realm_requirement");
	mm:add_new_objective("HAVE_AT_LEAST_X_OF_A_POOLED_RESOURCE");
	mm:add_condition("pooled_resource wh3_main_khorne_realm_points");
	mm:add_condition("total " .. cm:get_saved_value("khorne_points_required"));
	mm:add_payload("text_display dummy_wh3_main_khorne_realm_requirement");
	
	if is_from_narrative_event or cm:is_multiplayer() then
		mm:trigger();
	else
		cm:trigger_transient_intervention(
			"khorne_realm_requirement",
			function(inv)
				cm:callback(
					function()
						mm:trigger();
						inv:complete();
					end,
					0.5
				);
			end,
			true,
			function(inv)
				inv:set_must_trigger(true, true);
				inv:set_wait_for_fullscreen_panel_dismissed(false);
			end,
			0
		);
	end;
end;


function setup_realm_khorne(entering_faction)
	if not khorne_realm_initialised then
		if not cm:get_saved_value("khorne_realm_active") then
			-- look up bloodshed required
			current_points_required = points_required[math.min(cm:get_saved_value("ursuns_roar_count") or 1, 4)] * cm:model():unit_size_multiplier();
			cm:set_saved_value("khorne_points_required", current_points_required);
			
			-- setup creep armies
			setup_creep_army_comp(creep_armies, wh2_main_rogue_wrath_of_nature_setup, wh2_main_rogue_the_wandering_dead_setup, wh2_main_rogue_abominations_setup, wh2_main_rogue_beastcatchas_setup, wh2_main_rogue_celestial_storm_setup, wh3_main_kho_brazen_throne_setup);
			deploy_creep_armies(creep_armies, true, 300, -1, 2, true, true);
		end;
		
		-- only add the marker if the ancillary is available to be taken
		for encounter_id, data in pairs(khorne_realm_encounters) do
			if not cm:model():world():ancillary_exists(data[3]) then
				cm:remove_interactable_campaign_marker(encounter_id);
				cm:add_interactable_campaign_marker(encounter_id, encounter_id, data[1], data[2], 3);
			end;
		end;
		
		cm:remove_hex_area_trigger("khorne_end");
		cm:add_hex_area_trigger("khorne_end", final_pos[1], final_pos[2], 3);
		
		setup_ai_behaviour(
			function(context)
				local faction = context:faction();
				local faction_name = faction:name();
				
				-- ensure we're at war with all the factions in the realm as a failsafe
				for i = 1, #creep_armies do
					local current_faction = cm:get_faction(creep_armies[i][5]);
					
					if not current_faction:is_dead() and not current_faction:at_war_with(faction) then
						cm:force_declare_war(faction_name, creep_armies[i][5], false, false);
					end;
				end;
				
				local character = faction:faction_leader();
				
				local reached_required_points = faction:pooled_resource_manager():resource("wh3_main_khorne_realm_points"):value() >= current_points_required;
				
				local x = character:logical_position_x();
				local y = character:logical_position_y();
				
 				local closest_distance = 500000;
				local desired_position = {};
				
				if reached_required_points then
					out.chaos("\tReached the required points");
					desired_position.x = final_pos[1];
					desired_position.y = final_pos[2];
				elseif not has_khorne_weapon(character) and not character:character_subtype("wh3_main_dae_daemon_prince") then
					for encounter_id, data in pairs(khorne_realm_encounters) do
						local current_distance = distance_squared(x, y, data[1], data[2]);
						local model = cm:model();
						
						if current_distance < closest_distance and not model:world():ancillary_exists(data[3]) and x ~= data[1] and y ~= data[2] and model:character_can_ever_reach_position(character, data[1], data[2]) then
							closest_distance = current_distance;
							desired_position.x = data[1];
							desired_position.y = data[2];
						end;
					end;
				end;
				
				if not reached_required_points and find_target_and_attack(character, false, closest_distance) then
					core:add_listener(
						"target_attacked_khorne_realm",
						"BattleCompleted",
						true,
						function()
							-- Delay this, otherwise move is discarded - don't pass in character reference as it might expire in the interval
							cm:callback(function() attempt_to_move_realm_character_to_desired_location(faction_name, nil, desired_position) end, 0.2);
						end,
						false
					);
				else
					attempt_to_move_realm_character_to_desired_location(faction_name, character, desired_position);
				end;
			end,
			"khorne"
		);
		
		core:add_listener(
			"add_khorne_damage_points",
			"CharacterCompletedBattle",
			function(context)
				local faction = context:character():faction();
				local pb = context:pending_battle();
				
				return pb:set_piece_battle_key() == "" and not faction:pooled_resource_manager():resource("wh3_main_khorne_realm_points"):is_null_interface() and pb:region_data():key() == "wh3_main_chaos_region_the_blood_gods_domain" and pb:has_been_fought();
			end,
			function(context)
				local pb = cm:model():pending_battle();
				local character = context:character();
				local faction = character:faction();
				local faction_name = faction:name();
				local points_earned = 0;
				
				if character == pb:attacker() then
					points_earned = pb:defender_total_hp_lost();
					
					out.chaos("\t" .. faction_name .. " was attacker, attacker_ending_cp_kill_score is " .. points_earned);
				elseif character == pb:defender() then
					points_earned = pb:attacker_total_hp_lost();
					
					out.chaos("\t" .. faction_name .. " was defender, defender_ending_cp_kill_score is " .. points_earned);
				end;
				
				cm:faction_add_pooled_resource(faction_name, "wh3_main_khorne_realm_points", "other", points_earned);
				
				local points = faction:pooled_resource_manager():resource("wh3_main_khorne_realm_points"):value();
				
				out.chaos(faction_name .. " bloodshed: " .. points .. " / " .. current_points_required);
				
				if points >= current_points_required and faction:is_human() and faction:is_factions_turn() then
					trigger_realm_final_battle(faction_name, "khorne");
				end;
			end,
			true
		);
		
		-- if the points accumulate during the ai turns, we need to issue the mission at the start of the player's turn instead
		core:add_listener(
			"issue_khorne_realm_final_battle_mission",
			"FactionTurnStart",
			function(context)
				local faction = context:faction();
				
				return faction:is_human() and is_faction_in_realm(faction, "khorne") and faction:pooled_resource_manager():resource("wh3_main_khorne_realm_points"):value() >= current_points_required;
			end,
			function(context)
				trigger_realm_final_battle(context:faction():name(), "khorne");
			end,
			true
		);
		
		core:add_listener(
			"khorne_encounter_entered",
			"AreaEntered",
			function(context)
				local character = context:family_member():character();
				if not character:is_null_interface() then
					local faction = character:faction();
					local area_key = context:area_key();
					return area_key:starts_with("wh3_main_kho_") and not cm:model():world():ancillary_exists(khorne_realm_encounters[area_key][3]) and not faction:pooled_resource_manager():resource("wh3_main_realm_complete_khorne"):is_null_interface() and cm:char_is_general_with_army(character);
				end;
			end,
			function(context)
				local character = context:family_member():character();
				if character:is_null_interface() then
					return;
				end;

				local area_key = context:area_key();
				local faction = character:faction();
				local faction_cqi = faction:command_queue_index();
				
				if faction:is_human() then
					cm:trigger_incident_with_targets(faction_cqi, "wh3_main_incident_" .. area_key:gsub("wh3_main_", ""), 0, 0, character:command_queue_index(), 0, 0, 0);
				else
					cm:force_add_ancillary(character, khorne_realm_encounters[area_key][3], true, false);
				end;
				
				local unit_list = character:military_force():unit_list();
				
				for i = 0, unit_list:num_items() - 1 do
					cm:set_unit_hp_to_unary_of_maximum(unit_list:item_at(i), 1);
				end;
				
				cm:remove_interactable_campaign_marker(area_key);
				
				out.chaos("Got weapon: " .. khorne_realm_encounters[area_key][3]);
				
				local text_pos_x = character:display_position_x();
				local text_pos_y = character:display_position_y();
				cm:draw_text("Got weapon: " .. khorne_realm_encounters[area_key][3], text_pos_x, text_pos_y, 30, 4, 180, 0, 180);
			end,
			true
		);
		
		core:add_listener(
			"ai_reaches_end_of_khorne_realm",
			"AreaEntered",
			function(context)
				local character = context:family_member():character();
				if not character:is_null_interface() then
					local faction = character:faction();
					local prm = faction:pooled_resource_manager();
					
					return context:area_key() == "khorne_end" and not faction:is_human() and not prm:resource("wh3_main_realm_complete_khorne"):is_null_interface() and prm:resource("wh3_main_khorne_realm_points"):value() >= current_points_required and cm:char_is_general_with_army(character) and can_ai_army_complete_final_battle(character:military_force());
				end;
			end,
			function(context)
				close_realm(context:family_member():character_details():faction():name(), "khorne");
			end,
			false
		);
		
		-- set the creep armies to have already retreated each turn
		core:add_listener(
			"khorne_realm_set_army_retreated",
			"WorldStartRound",
			true,
			function()
				for i = 1, #creep_armies do
					local mf_list = cm:get_faction(creep_armies[i][5]):military_force_list();
					
					for i = 0, mf_list:num_items() - 1 do
						cm:set_force_has_retreated_this_turn(mf_list:item_at(i));
					end;
				end;
			end,
			true
		);
		
		current_points_required = cm:get_saved_value("khorne_points_required");
		common.set_context_value("khorne_points_required", current_points_required);
	end;
	
	-- listeners have been established, only set them up again if a save is loaded
	khorne_realm_initialised = true;
	
	if entering_faction then
		if entering_faction:is_human() then
			local entering_faction_name = entering_faction:name();
			
			-- If the Khorne realm cindyscene hasn't been played before then don't issue the mission - the narrative scripts will do it.
			if cm:get_saved_value("khorne_realm_cindyscene_played_" .. entering_faction_name) then
				issue_khorne_realm_mission(entering_faction_name, false);
			end;
		else
			toggle_faction_leader_ai(entering_faction, false);
		end;
	end;
	
	cm:set_saved_value("khorne_realm_active", true);
end;

function has_khorne_weapon(character)
	for encounter_id, data in pairs(khorne_realm_encounters) do
		if character:has_ancillary(data[3]) then
			return true;
		end;
	end;
	
	return false;
end;

function close_khorne_realm()
	kill_realm_armies(creep_armies);
	
	khorne_realm_initialised = false;
	
	reset_khorne_realm_points();
	
	cm:set_saved_value("khorne_points_required", false);
	
	cm:remove_hex_area_trigger("khorne_end");
	
	core:remove_listener("target_attacked_khorne_realm");
	core:remove_listener("khorne_encounter_entered");
	core:remove_listener("ai_reaches_end_of_khorne_realm");
	core:remove_listener("khorne_realm_set_army_retreated");
	core:remove_listener("issue_khorne_realm_final_battle_mission");
	
	for encounter_id, data in pairs(khorne_realm_encounters) do
		cm:remove_interactable_campaign_marker(encounter_id);
	end;
	
	cm:set_saved_value("khorne_realm_active", false);
end;

function reset_khorne_realm_points(faction)
	if faction then
		local khorne_realm_points = faction:pooled_resource_manager():resource("wh3_main_khorne_realm_points");
		
		if not khorne_realm_points:is_null_interface() then
			cm:faction_add_pooled_resource(faction:name(), "wh3_main_khorne_realm_points", "other", - khorne_realm_points:value());
		end;
	else
		local faction_list = cm:model():world():faction_list();
		
		for i = 0, faction_list:num_items() - 1 do
			reset_khorne_realm_points(faction_list:item_at(i));
		end;
	end;
end;