local ai_army_setups = {
	-- first rift opening
	{
		{ -- 12500
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_plaguebearers_0",
			"wh3_main_nur_inf_plaguebearers_0",
			"wh3_main_nur_inf_forsaken_0",
			"wh3_main_nur_inf_forsaken_0",
			"wh3_main_nur_inf_chaos_furies_0",
			"wh3_main_nur_mon_plague_toads_0",
			"wh3_main_nur_cav_pox_riders_of_nurgle_0",
			"wh3_main_nur_mon_spawn_of_nurgle_0",
			"wh3_main_nur_mon_spawn_of_nurgle_0"
		},
		{
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_plaguebearers_0",
			"wh3_main_nur_inf_forsaken_0",
			"wh3_main_nur_inf_chaos_furies_0",
			"wh3_main_nur_mon_beast_of_nurgle_0",
			"wh3_main_nur_mon_beast_of_nurgle_0",
			"wh3_main_nur_mon_beast_of_nurgle_0",
			"wh3_main_nur_mon_plague_toads_0",
			"wh3_main_nur_cav_pox_riders_of_nurgle_0"
		}
	},
	-- second rift opening
	{
		{ -- 17500
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_plaguebearers_0",
			"wh3_main_nur_inf_plaguebearers_0",
			"wh3_main_nur_inf_forsaken_0",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_chaos_furies_0",
			"wh3_main_nur_inf_chaos_furies_0",
			"wh3_main_nur_inf_chaos_furies_0",
			"wh3_main_nur_inf_chaos_furies_0",
			"wh3_main_nur_mon_beast_of_nurgle_0",
			"wh3_main_nur_mon_rot_flies_0",
			"wh3_main_nur_mon_rot_flies_0",
			"wh3_main_nur_cav_pox_riders_of_nurgle_0",
			"wh3_main_nur_cav_pox_riders_of_nurgle_0",
			"wh3_main_nur_mon_great_unclean_one_0"
		},
		{
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_plaguebearers_0",
			"wh3_main_nur_inf_plaguebearers_0",
			"wh3_main_nur_inf_plaguebearers_0",
			"wh3_main_nur_inf_forsaken_0",
			"wh3_main_nur_inf_forsaken_0",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_chaos_furies_0",
			"wh3_main_nur_mon_beast_of_nurgle_0",
			"wh3_main_nur_mon_beast_of_nurgle_0",
			"wh3_main_nur_mon_plague_toads_0",
			"wh3_main_nur_mon_plague_toads_0",
			"wh3_main_nur_mon_plague_toads_0",
			"wh3_main_nur_cav_pox_riders_of_nurgle_0",
			"wh3_main_nur_cav_pox_riders_of_nurgle_0",
			"wh3_main_nur_cav_plague_drones_1"
		},
	},
	-- third rift opening
	{
		{ -- 22500
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_plaguebearers_0",
			"wh3_main_nur_inf_plaguebearers_0",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_chaos_furies_0",
			"wh3_main_nur_mon_beast_of_nurgle_0",
			"wh3_main_nur_mon_beast_of_nurgle_0",
			"wh3_main_nur_cav_pox_riders_of_nurgle_0",
			"wh3_main_nur_cav_pox_riders_of_nurgle_0",
			"wh3_main_nur_mon_spawn_of_nurgle_0",
			"wh3_main_nur_cav_plague_drones_0",
			"wh3_main_nur_mon_soul_grinder_0",
			"wh3_main_nur_mon_soul_grinder_0",
			"wh3_main_nur_mon_soul_grinder_0"
		},
		{
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_plaguebearers_0",
			"wh3_main_nur_inf_plaguebearers_0",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_mon_plague_toads_0",
			"wh3_main_nur_mon_plague_toads_0",
			"wh3_main_nur_cav_pox_riders_of_nurgle_0",
			"wh3_main_nur_cav_pox_riders_of_nurgle_0",
			"wh3_main_nur_cav_pox_riders_of_nurgle_0",
			"wh3_main_nur_cav_pox_riders_of_nurgle_0",
			"wh3_main_nur_cav_plague_drones_0",
			"wh3_main_nur_cav_plague_drones_0",
			"wh3_main_nur_mon_great_unclean_one_0",
			"wh3_main_nur_mon_great_unclean_one_0"
		}
	},
	-- fourth+ rift opening
	{
		{ -- 27500
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_plaguebearers_0",
			"wh3_main_nur_inf_forsaken_0",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_mon_beast_of_nurgle_0",
			"wh3_main_nur_cav_pox_riders_of_nurgle_0",
			"wh3_main_nur_cav_pox_riders_of_nurgle_0",
			"wh3_main_nur_mon_spawn_of_nurgle_0",
			"wh3_main_nur_cav_plague_drones_0",
			"wh3_main_nur_mon_great_unclean_one_0",
			"wh3_main_nur_mon_great_unclean_one_0",
			"wh3_main_nur_mon_great_unclean_one_0",
			"wh3_main_nur_cav_plague_drones_1",
			"wh3_main_nur_mon_soul_grinder_0"
		},
		{
			"wh3_main_nur_inf_nurglings_0",
			"wh3_main_nur_inf_plaguebearers_0",
			"wh3_main_nur_inf_forsaken_0",
			"wh3_main_nur_inf_forsaken_0",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_inf_plaguebearers_1",
			"wh3_main_nur_mon_beast_of_nurgle_0",
			"wh3_main_nur_mon_rot_flies_0",
			"wh3_main_nur_cav_pox_riders_of_nurgle_0",
			"wh3_main_nur_cav_pox_riders_of_nurgle_0",
			"wh3_main_nur_mon_great_unclean_one_0",
			"wh3_main_nur_mon_great_unclean_one_0",
			"wh3_main_nur_cav_plague_drones_1",
			"wh3_main_nur_mon_soul_grinder_0",
			"wh3_main_nur_mon_soul_grinder_0",
			"wh3_main_nur_mon_soul_grinder_0"
		}
	},
};

local creep_armies = {
	{
		"nurgle_inv_1",
		"",
		{527, 569},
		{{x = 527, y = 569}, {x = 527, y = 569}},
		"wh3_main_nur_bubonic_swarm"
	},
	{
		"nurgle_inv_2",
		"",
		{520, 562},
		{{x = 520, y = 562}, {x = 520, y = 562}},
		"wh3_main_nur_bubonic_swarm"
	},
	{
		"nurgle_inv_3",
		"",
		{556, 543},
		{{x = 556, y = 543}, {x = 556, y = 543}},
		"wh3_main_nur_bubonic_swarm"
	},
	{
		"nurgle_inv_4",
		"",
		{601, 583},
		{{x = 601, y = 583}, {x = 601, y = 583}},
		"wh3_main_nur_bubonic_swarm"
	},
	{
		"nurgle_inv_5",
		"",
		{619, 586},
		{{x = 619, y = 586}, {x = 619, y = 586}},
		"wh3_main_nur_bubonic_swarm"
	},
	{
		"nurgle_inv_6",
		"",
		{631, 546},
		{{x = 631, y = 546}, {x = 631, y = 546}},
		"wh3_main_nur_bubonic_swarm"
	},
	{
		"nurgle_inv_7",
		"",
		{618, 550},
		{{x = 618, y = 550}, {x = 618, y = 550}},
		"wh3_main_nur_bubonic_swarm"
	}
};

local positions = {
	{582, 519, "wh3_main_nur_lair_of_the_maggot_lord"},
	{496, 582, "wh3_main_nur_the_great_tree"},
	{598, 555, "wh3_main_nur_the_septic_isle"},
	{617, 607, "wh3_main_nur_arghus_the_plague_moon"}
};

local final_pos = {564, 588};

local nurgle_realm_initialised = false;

-- Issue the Nurgle Realm mission. This may be called from within this script, or by the narrative scripts.
function issue_nurgle_realm_mission(faction_key, is_from_narrative_event)
	out.chaos("issue_nurgle_realm_mission() called, faction_key is " .. faction_key);
	local furthest_position = cm:get_saved_value(faction_key .. "_nurgle_realm_encounter_required");
	
	local mm = mission_manager:new(faction_key, "wh3_main_nurgle_realm_requirement");
	mm:add_new_objective("SCRIPTED");
	mm:add_condition("script_key nurgle_realm_requirement_" .. faction_key);
	mm:add_condition("override_text mission_text_text_" .. furthest_position[3]);
	mm:set_position(furthest_position[1], furthest_position[2]);
	mm:add_payload("text_display dummy_wh3_main_nurgle_realm_requirement");
	
	if cm:is_multiplayer() then
		mm:trigger();
	else
		cm:trigger_transient_intervention(
			"nurgle_realm_requirement",
			function(inv)
				cm:callback(
					function()
						mm:trigger();
						inv:complete();
					end,
					0.5
				);
			end,
			true,
			function(inv)
				inv:set_must_trigger(true, true);
				inv:set_wait_for_fullscreen_panel_dismissed(false);
			end,
			0
		);
	end;
end;


function setup_realm_nurgle(entering_faction)
	if not nurgle_realm_initialised then
		if not cm:get_saved_value("nurgle_realm_active") then
			-- Setup creep armies
			setup_creep_army_comp(creep_armies, ai_army_setups);
			deploy_creep_armies(creep_armies, true, 100, -1, 3, true);
		end;
		
		for i = 1, #positions do
			cm:remove_interactable_campaign_marker(positions[i][3]);
			cm:add_interactable_campaign_marker(positions[i][3], positions[i][3], positions[i][1], positions[i][2], 3);
		end;
		
		cm:remove_hex_area_trigger("nurgle_end");
		cm:add_hex_area_trigger("nurgle_end", final_pos[1], final_pos[2], 3);
		
		core:add_listener(
			"nurgle_encounter_entered",
			"AreaEntered",
			function(context)
				local character = context:family_member():character();
				if not character:is_null_interface() then
					local area_key = context:area_key();
					return area_key:starts_with("wh3_main_nur_") and not character:faction():pooled_resource_manager():resource("wh3_main_realm_complete_khorne"):is_null_interface() and cm:char_is_general_with_army(character) and not cm:model():pending_battle():is_active();
				end;
			end,
			function(context)
				local character = context:family_member():character();
				if character:is_null_interface() then
					return;
				end;

				local area_key = context:area_key();
				local faction = character:faction();
				local faction_name = faction:name();
				local is_human = faction:is_human();
				local mf = character:military_force();
				local encounter_required = cm:get_saved_value(faction_name .. "_nurgle_realm_encounter_required");
				
				if encounter_required and encounter_required[3] == area_key then
					-- clear the save value, so the ai knows it's already visited the location
					cm:set_saved_value(faction_name .. "_nurgle_realm_encounter_required", false);
					
					if is_human then
						cm:complete_scripted_mission_objective(faction_name, "wh3_main_nurgle_realm_requirement", "nurgle_realm_requirement_" .. faction_name, true);
						trigger_realm_final_battle(faction_name, "nurgle");
					end;
				end;
				
				if is_human then
					cm:trigger_incident_with_targets(faction:command_queue_index(), "wh3_main_incident_" .. area_key, 0, 0, 0, mf:command_queue_index(), 0, 0);
				else
					cm:apply_effect_bundle_to_characters_force(area_key, character:command_queue_index(), 20);
				end;
				
				local unit_list = mf:unit_list();
				
				for i = 0, unit_list:num_items() - 1 do
					cm:set_unit_hp_to_unary_of_maximum(unit_list:item_at(i), 1);
				end;
				
				out.chaos("Got effect bundle: " .. area_key);
				
				local text_pos_x = character:display_position_x();
				local text_pos_y = character:display_position_y();
				
				cm:draw_text("Got effect bundle: " .. area_key, text_pos_x, text_pos_y, 5, 4, 180, 0, 180);
			end,
			true
		);
		
		core:add_listener(
			"ai_reaches_end_of_nurgle_realm",
			"AreaEntered",
			function(context)
				local character = context:family_member():character();
				if not character:is_null_interface() then
					local faction = character:faction();
					return context:area_key() == "nurgle_end" and not faction:is_human() and not faction:pooled_resource_manager():resource("wh3_main_realm_complete_khorne"):is_null_interface() and cm:char_is_general_with_army(character) and can_ai_army_complete_final_battle(character:military_force());
				end;
			end,
			function(context)
				close_realm(context:family_member():character_details():faction():name(), "nurgle");
			end,
			false
		);
		
		setup_ai_behaviour(
			function(context)
				local faction = context:faction();
				local faction_name = faction:name();
				local faction_leader = faction:faction_leader();
				local desired_encounter = cm:get_saved_value(faction_name .. "_nurgle_realm_encounter_required");
				
				-- move to the encounter first
				if desired_encounter then
					attempt_to_move_realm_character_to_desired_location(faction_name, faction_leader, {x = desired_encounter[1], y = desired_encounter[2]});
				-- the encounter has been reached, move to the final battle location
				elseif not attempt_to_move_realm_character_to_desired_location(faction_name, faction_leader, {x = final_pos[1], y = final_pos[2]}) and faction_leader:has_military_force() then
					-- can't move the army to the final battle position, and we're too weak to find a target to attack, so move to the nearest encounter that we haven't already visited
					local mf = faction_leader:military_force();
					local closest_distance = 500000;
					local desired_position = {};
					
					for i = 1, #positions do
						if not mf:has_effect_bundle(positions[i][3]) then
							local current_distance = distance_squared(faction_leader:logical_position_x(), faction_leader:logical_position_y(), positions[i][1], positions[i][2]);
							
							if current_distance < closest_distance then
								closest_distance = current_distance;
								desired_position.x = positions[i][1];
								desired_position.y = positions[i][2];
							end;
						end;
					end;
					
					attempt_to_move_realm_character_to_desired_location(faction_name, faction_leader, desired_position);
				end;
			end,
			"nurgle"
		);
	end;
	
	-- listeners have been established, only set them up again if a save is loaded
	nurgle_realm_initialised = true;
	
	if entering_faction then
		local character = entering_faction:faction_leader();
		local furthest_distance = 0;
		local furthest_position = nil;
		
		-- find the furthest encounter position
		for i = 1, #positions do
			local current_distance = distance_squared(positions[i][1], positions[i][2], character:logical_position_x(), character:logical_position_y());
			
			if current_distance > furthest_distance then
				furthest_distance = current_distance;
				furthest_position = positions[i];
			end;
		end;
		
		local entering_faction_name = entering_faction:name();
		
		cm:set_saved_value(entering_faction_name .. "_nurgle_realm_encounter_required", furthest_position);
		
		if entering_faction:is_human() then
			-- If the Nurgle realm cindyscene hasn't been played before then don't issue the mission - the narrative scripts will do it.
			if cm:get_saved_value("nurgle_realm_cindyscene_played_" .. entering_faction_name) then
				issue_nurgle_realm_mission(entering_faction_name, false);
			end;
		else
			toggle_faction_leader_ai(entering_faction, false);
		end;
	end;
	
	cm:set_saved_value("nurgle_realm_active", true);
end;

function close_nurgle_realm()
	core:remove_listener("target_attacked_nurgle_realm");
	core:remove_listener("nurgle_encounter_entered");
	core:remove_listener("ai_reaches_end_of_nurgle_realm");
	nurgle_realm_initialised = false;
	
	cm:remove_hex_area_trigger("nurgle_end");
	
	kill_realm_armies(creep_armies);
	
	for i = 1, #positions do
		cm:remove_interactable_campaign_marker(positions[i][3]);
	end;
	
	cm:set_saved_value("nurgle_realm_active", false);
end;