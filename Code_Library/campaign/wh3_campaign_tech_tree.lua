scripted_technology_tree = {
	region_mapping = {
		wh3_main_combi_region_naggarond = {
			wh_dlc08_tech_nor_nw_03 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_lothern = {
			wh_dlc08_tech_nor_nw_05 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_hexoatl = {
			wh_dlc08_tech_nor_nw_07 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_skavenblight = {
			wh_dlc08_tech_nor_nw_09 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_khemri = {
			wh_dlc08_tech_nor_nw_11 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_the_awakening = {
			wh_dlc08_tech_nor_nw_21 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_couronne = {
			wh_dlc08_tech_nor_other_08 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_miragliano = {
			wh_dlc08_tech_nor_other_10 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_karaz_a_karak = {
			wh_dlc08_tech_nor_other_12 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_altdorf = {
			wh_dlc08_tech_nor_other_15 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_castle_drakenhof = {
			wh_dlc08_tech_nor_other_17 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_black_crag = {
			wh_dlc08_tech_nor_other_19 = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		},
		wh3_main_combi_region_kislev = {
			wh3_main_ie_tech_nor_oldworld_kislev_capital = {culture = "wh_dlc08_nor_norsca", allow_allies = false},
			wh3_main_tech_ksl_2_10 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_2_11 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_2_12 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_2_13 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_2_14 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_2_15 = {culture = "wh3_main_ksl_kislev", allow_allies = true}
		},
		wh3_main_chaos_region_kislev = {
			wh3_main_ie_tech_nor_oldworld_kislev_capital = {culture = "wh_dlc08_nor_norsca", allow_allies = false},
			wh3_main_tech_ksl_2_10 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_2_11 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_2_12 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_2_13 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_2_14 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_2_15 = {culture = "wh3_main_ksl_kislev", allow_allies = true}
		},
		wh3_main_combi_region_praag = {
			wh3_main_tech_ksl_4_10 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_4_11 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_4_12 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_4_13 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_4_14 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_4_15 = {culture = "wh3_main_ksl_kislev", allow_allies = true}
		},
		wh3_main_chaos_region_praag = {
			wh3_main_tech_ksl_4_10 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_4_11 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_4_12 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_4_13 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_4_14 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_4_15 = {culture = "wh3_main_ksl_kislev", allow_allies = true}
		},
		wh3_main_combi_region_erengrad = {
			wh3_main_tech_ksl_3_10 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_3_11 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_3_12 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_3_13 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_3_14 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_3_15 = {culture = "wh3_main_ksl_kislev", allow_allies = true}
		},
		wh3_main_chaos_region_erengrad = {
			wh3_main_tech_ksl_3_10 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_3_11 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_3_12 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_3_13 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_3_14 = {culture = "wh3_main_ksl_kislev", allow_allies = true},
			wh3_main_tech_ksl_3_15 = {culture = "wh3_main_ksl_kislev", allow_allies = true}
		},
		wh3_main_combi_region_wei_jin = {
			wh3_main_ie_tech_nor_darklands_cathay_capital = {culture = "wh_dlc08_nor_norsca", allow_allies = false}
		}
	},
	ancillary_mapping = {
		wh2_dlc11_tech_cst_firearms_07 =	"wh2_dlc11_anc_follower_cst_powder_monkey",
		wh2_dlc11_tech_cst_firearms_08 =	"wh2_dlc11_anc_follower_cst_master_gunner",
		wh2_dlc11_tech_cst_firearms_09 =	"wh2_dlc11_anc_magic_standard_throwing_bombs",
		wh2_dlc11_tech_cst_vampiric_10 =	"wh2_dlc11_anc_magic_standard_spell_of_the_necromancers_apprentice",
		wh2_dlc11_tech_cst_vampiric_11 =	"wh2_dlc11_anc_magic_standard_skull_and_crossbones",
		wh2_dlc11_tech_cst_vampiric_12 =	"wh2_dlc11_anc_follower_cst_carpenter",
		wh2_dlc11_tech_cst_command_10 =		"wh2_dlc11_anc_follower_cst_quartermaster",
		wh2_dlc11_tech_cst_command_11 =		"wh2_dlc11_anc_follower_cst_first_mate",
		wh2_dlc11_tech_cst_command_12 =		"wh2_dlc11_anc_follower_cst_sea_artist",
		wh3_main_tech_cth_2 =				"wh3_main_anc_magic_standard_banner_of_feng_shi",
		wh3_main_tech_cth_22 =				"wh3_main_anc_magic_standard_banner_of_the_moon_empress",
		wh3_main_tech_cth_50 =				"wh3_main_anc_magic_standard_the_great_celestial_banner",
		wh3_main_tech_cth_65 =				"wh3_main_anc_magic_standard_banner_of_the_empress_eye",
		wh3_main_tech_kho_1_5 =				"wh3_main_anc_magic_standard_blood_feasters_banner",
		wh3_main_tech_kho_3_5 =				"wh3_main_anc_magic_standard_trophy_of_killers",
		wh3_main_tech_kho_4_3 =				"wh3_main_anc_magic_standard_khornes_gift",
		wh3_main_tech_kho_6_2 =				"wh3_main_anc_magic_standard_lifetaker_banner",
		wh3_main_tech_ksl_4_14 =			"wh3_main_anc_magic_standard_banner_of_the_orthodoxy"
	}
}

function scripted_technology_tree:start_technology_listeners()
	if cm:is_new_game() then
		for region_key, technologies in pairs(self.region_mapping) do
			local region = cm:get_region(region_key)
			
			if region then
				-- lock the technology for all factions
				self:toggle_technology(technologies)
				
				-- unlock it for the owner in the start pos
				
				if not region:is_abandoned() then
					self:toggle_technology(technologies, region:owning_faction())
				end
			end
		end
	end
	
	core:add_listener(
		"tech_researched_ancillary_provided",
		"ResearchCompleted",
		true,
		function(context)
			local ancillary = self.ancillary_mapping[context:technology()]
				
			if ancillary then
				cm:add_ancillary_to_faction(context:faction(), ancillary, false)
			end
		end,
		true
	)
	
	core:add_listener(
		"region_changed_technology_unlock",
		"RegionFactionChangeEvent",
		function(context)
			return self.region_mapping[context:region():name()]
		end,
		function(context)
			local region = context:region()
			local owning_faction = false
			
			if not region:is_abandoned() then
				owning_faction = region:owning_faction()
			end
			
			self:toggle_technology(self.region_mapping[region:name()], owning_faction)
		end,
		true
	)
	
	core:add_listener(
		"diplomatic_treaty_technology_unlock",
		"PositiveDiplomaticEvent",
		function(context)
			return context:is_military_alliance() or context:is_defensive_alliance() or context:is_vassalage()
		end,
		function(context)
			self:resolve_diplomatic_event(context:proposer(), context:recipient())
		end,
		true
	)
	
	core:add_listener(
		"diplomatic_treaty_technology_unlock",
		"NegativeDiplomaticEvent",
		function(context)
			return context:was_military_alliance() or context:was_defensive_alliance() or context:was_vassalage()
		end,
		function(context)
			self:resolve_diplomatic_event(context:proposer(), context:recipient())
		end,
		true
	)
end

function scripted_technology_tree:resolve_diplomatic_event(proposer, recipient)
	-- delay this by a tick as the treaty isn't created until just after this event
	cm:callback(
		function()
			for region_key, technologies in pairs(self.region_mapping) do
				local region = cm:get_region(region_key)
				
				if region and not region:is_abandoned() then
					local owning_faction = region:owning_faction()
					
					if owning_faction == proposer then
						self:toggle_technology(technologies, proposer)
					elseif owning_faction == recipient then
						self:toggle_technology(technologies, recipient)
					end
				end
			end
		end,
		0.2
	)
end

function scripted_technology_tree:toggle_technology(technologies, region_owner)
	-- unlock each technology tied to the region for the new owner and allies if needed
	if region_owner and not region_owner:is_rebel() then
		local faction_culture = region_owner:culture()
		-- build a list of allies and vassals
		local ally_list = {}
		for _, current_faction in model_pairs(region_owner:factions_allied_with()) do
			table.insert(ally_list, current_faction)
		end
		for _, current_faction in model_pairs(region_owner:vassals()) do
			table.insert(ally_list, current_faction)
		end
		
		for technology_key, details in pairs(technologies) do
			if faction_culture == details.culture then
				cm:unlock_technology(region_owner:name(), technology_key)
			end
			
			if details.allow_allies then
				for i = 1, #ally_list do
					local current_ally = ally_list[i]
					
					if current_ally:culture() == details.culture then
						cm:unlock_technology(current_ally:name(), technology_key)
					end
				end
			end
		end
	end
	
	-- lock the technology for every other faction, excluding allies if needed, of that culture
	local faction_list = cm:model():world():faction_list()
	
	for _, current_faction in model_pairs(faction_list) do
		local current_faction_culture = current_faction:culture()
		
		for technology_key, details in pairs(technologies) do
			if current_faction_culture == details.culture and region_owner ~= current_faction and (not region_owner or (details.allow_allies and region_owner and not region_owner:is_ally_vassal_or_client_state_of(current_faction))) then
				cm:lock_technology(current_faction:name(), technology_key)
			end
		end
	end
end