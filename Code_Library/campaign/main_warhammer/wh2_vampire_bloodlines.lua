vampire_bloodlines = {
	bloodline_details = {
		bloodline_von_carstein =	{subtype = "wh2_dlc11_vmp_bloodline_von_carstein",	artset = "",	male_lords = true,	forced_surname = "names_name_2147343895",	unit_reward = "wh2_dlc11_vmp_inf_crossbowmen",	max_level_reward = "wh2_dlc11_vmp_inf_handgunners"},
		bloodline_blood_dragon =	{subtype = "wh2_dlc11_vmp_bloodline_blood_dragon",	artset = "",	male_lords = true,	forced_surname = "",						unit_reward = "",								max_level_reward = ""},
		bloodline_lahmian =			{subtype = "wh2_dlc11_vmp_bloodline_lahmian",		artset = "",	male_lords = false,	forced_surname = "",						unit_reward = "",								max_level_reward = ""},
		bloodline_necrarch =		{subtype = "wh2_dlc11_vmp_bloodline_necrarch",		artset = "",	male_lords = true,	forced_surname = "",						unit_reward = "",								max_level_reward = ""},
		bloodline_strigoi =			{subtype = "wh2_dlc11_vmp_bloodline_strigoi",		artset = "",	male_lords = true,	forced_surname = "",						unit_reward = "",								max_level_reward = ""}
	},
	male_forenames = {
		"names_name_1406951171",
		"names_name_1768171990",
		"names_name_1880091843",
		"names_name_1966785637",
		"names_name_2147345100",
		"names_name_2147345109",
		"names_name_2147345117",
		"names_name_2147345149",
		"names_name_2147345161",
		"names_name_2147345165",
		"names_name_2147345166",
		"names_name_2147345180",
		"names_name_2147345200",
		"names_name_2147345209",
		"names_name_2147345217",
		"names_name_2147345230",
		"names_name_2147345239",
		"names_name_2147345257",
		"names_name_2147345260",
		"names_name_2147345266",
		"names_name_2147345279",
		"names_name_2147345281",
		"names_name_2147345303",
		"names_name_2147345862",
		"names_name_2147345872",
		"names_name_2147357264",
		"names_name_2147357272",
		"names_name_2147357278",
		"names_name_2147357284",
		"names_name_2147357289",
		"names_name_2147357295",
		"names_name_2147357301",
		"names_name_2147357304",
		"names_name_2147357306",
		"names_name_2147357315",
		"names_name_2147357322",
		"names_name_2147357330",
		"names_name_2147357531",
		"names_name_2147357577",
		"names_name_2147357583",
		"names_name_2147357593",
		"names_name_2147357595",
		"names_name_2147357596",
		"names_name_2147357905",
		"names_name_2147357909",
		"names_name_2147357911",
		"names_name_2147357919",
		"names_name_2147357925",
		"names_name_2147357928",
		"names_name_2147357935",
		"names_name_2147357949",
		"names_name_2147357952",
		"names_name_2147357970",
		"names_name_2147357974",
		"names_name_2147357977",
		"names_name_2147357980",
		"names_name_2147357990",
		"names_name_2147357991",
		"names_name_2147357994",
		"names_name_2147358006",
		"names_name_2147358011",
		"names_name_2147358022",
		"names_name_2147358030",
		"names_name_2147358038",
		"names_name_2147358047",
		"names_name_2147358057",
		"names_name_2147358063",
		"names_name_2147358070",
		"names_name_2147358072",
		"names_name_2147358074",
		"names_name_2147358076",
		"names_name_2147358083",
		"names_name_2147358089",
		"names_name_2147358096",
		"names_name_2147358103",
		"names_name_2147358110",
		"names_name_2147358113",
		"names_name_2147358121",
		"names_name_2147358122",
		"names_name_2147358126",
		"names_name_2147358136",
		"names_name_2147358140",
		"names_name_2147358143",
		"names_name_2147358144",
		"names_name_2147358148",
		"names_name_2147358157",
		"names_name_2147358165",
		"names_name_2147358170",
		"names_name_2147358174",
		"names_name_2147358184",
		"names_name_2147358193",
		"names_name_2147358194",
		"names_name_2147358199",
		"names_name_2147358201",
		"names_name_2147358210",
		"names_name_2147358220",
		"names_name_2147358224",
		"names_name_2147358230",
		"names_name_2147358234",
		"names_name_2147358241",
		"names_name_2147358243",
		"names_name_2147358244",
		"names_name_2147358248",
		"names_name_2147358254",
		"names_name_2147358259",
		"names_name_2147358260",
		"names_name_2147358265",
		"names_name_2147358275",
		"names_name_2147358279",
		"names_name_2147358289",
		"names_name_2147358298",
		"names_name_2147358299",
		"names_name_2147358304",
		"names_name_2147358305",
		"names_name_2147358308",
		"names_name_2147358310",
		"names_name_2147358319",
		"names_name_2147358324",
		"names_name_677402052",
		"names_name_79061478"
	},
	ritual_to_bloodline = {
		wh2_dlc11_vmp_ritual_bloodline_awaken_von_carstein = "bloodline_von_carstein",
		wh2_dlc11_vmp_ritual_bloodline_awaken_lahmian = "bloodline_lahmian",
		wh2_dlc11_vmp_ritual_bloodline_awaken_necrarch = "bloodline_necrach",
		wh2_dlc11_vmp_ritual_bloodline_awaken_strigoi = "bloodline_strigoi",
		wh2_dlc11_vmp_ritual_bloodline_awaken_blood_dragon = "bloodline_blood_dragon",
		wh2_dlc11_vmp_ritual_bloodline_awaken_blood_dragon_01 = "bloodline_blood_dragon",
		wh2_dlc11_vmp_ritual_bloodline_awaken_blood_dragon_02 = "bloodline_blood_dragon",
		wh2_dlc11_vmp_ritual_bloodline_awaken_blood_dragon_03 = "bloodline_blood_dragon",
		wh2_dlc11_vmp_ritual_bloodline_awaken_lahmian_01 = "bloodline_lahmian",
		wh2_dlc11_vmp_ritual_bloodline_awaken_lahmian_02 = "bloodline_lahmian",
		wh2_dlc11_vmp_ritual_bloodline_awaken_lahmian_03 = "bloodline_lahmian",
		wh2_dlc11_vmp_ritual_bloodline_awaken_necrarch_01 = "bloodline_necrarch",
		wh2_dlc11_vmp_ritual_bloodline_awaken_necrarch_02 = "bloodline_necrarch",
		wh2_dlc11_vmp_ritual_bloodline_awaken_necrarch_03 = "bloodline_necrarch",
		wh2_dlc11_vmp_ritual_bloodline_awaken_strigoi_01 = "bloodline_strigoi",
		wh2_dlc11_vmp_ritual_bloodline_awaken_strigoi_02 = "bloodline_strigoi",
		wh2_dlc11_vmp_ritual_bloodline_awaken_strigoi_03 = "bloodline_strigoi",
		wh2_dlc11_vmp_ritual_bloodline_awaken_von_carstein_01 = "bloodline_von_carstein",
		wh2_dlc11_vmp_ritual_bloodline_awaken_von_carstein_02 = "bloodline_von_carstein",
		wh2_dlc11_vmp_ritual_bloodline_awaken_von_carstein_03 = "bloodline_von_carstein"
	},
	assassination_actions = {
		wh2_main_agent_action_champion_hinder_agent_assassinate = true,
		wh2_main_agent_action_runesmith_hinder_character_assassinate = true,
		wh2_main_agent_action_spy_hinder_agent_assassinate = true,
		wh2_main_agent_action_champion_hinder_agent_wound = true,
		wh2_main_agent_action_dignitary_hinder_agent_wound = true,
		wh2_main_agent_action_engineer_hinder_agent_wound = true,
		wh2_main_agent_action_runesmith_hinder_agent_wound = true,
		wh2_main_agent_action_wizard_hinder_agent_wound = true
	},
	technologies = {
		wh_main_tech_vmp_blood_01 = 1
	},
	bloodline_to_effects = {
		bloodline_von_carstein = "wh2_dlc11_vmp_ritual_bloodline_awaken_von_carstein_bundle_0",
		bloodline_blood_dragon = "wh2_dlc11_vmp_ritual_bloodline_awaken_blood_dragon_bundle_0",
		bloodline_lahmian =	"wh2_dlc11_vmp_ritual_bloodline_awaken_lahmian_bundle_0",
		bloodline_necrarch = "wh2_dlc11_vmp_ritual_bloodline_awaken_necrarch_bundle_0",
		bloodline_strigoi = "wh2_dlc11_vmp_ritual_bloodline_awaken_strigoi_bundle_0"
	},
	-- Some factions can start with extra Bloodkisses. If unspecified, a faction gets nothing.
	faction_starting_kisses = {
		wh_main_vmp_vampire_counts = {
			-- Only vlad gets a Blood Kiss for Vamp Counts, and he's identified using his effect bundle.
			required_effect_bundle = "wh_main_lord_trait_vmp_mannfred_von_carstein",
			amount = 1,
		},
		wh_main_vmp_schwartzhafen = {
			amount = 1,
		},
	},
	
	--Controls which script context the AI will use (and so which batch of lords it will priorities going for)
	faction_script_context = {
		wh_main_vmp_vampire_counts = {
			context = "cai_faction_script_context_alpha", --Von Carstein Lords first
		},
		wh_main_vmp_schwartzhafen = {
			context = "cai_faction_script_context_alpha",
		},
		wh3_main_vmp_lahmian_sisterhood = {
			context = "cai_faction_script_context_gamma", -- Lahmian lords first
		},
		wh2_main_vmp_necrarch_brotherhood = {
			context = "cai_faction_script_context_beta", -- Necrarch lords first
		},
		wh3_main_vmp_caravan_of_blue_roses = {
			context = "cai_faction_script_context_beta",
		},
		wh2_dlc11_vmp_the_barrow_legion ={
			context = "cai_faction_script_context_beta",
		},
	},
	-- State data.
	levels = {},
	unit_caps = {},
	vassals = {},
}

function vampire_bloodlines:add_bloodlines_listeners()
	out("#### Adding Vampire Bloodlines Listeners ####");
	if cm:is_new_game() == true then
		for key, value in pairs(self.faction_starting_kisses) do
			local faction = cm:get_faction(key);
			-- If there's a required effect bundle, and the faction lacks it, skip them.
			if not (value.required_effect_bundle and not faction:has_effect_bundle(value.required_effect_bundle)) then
				cm:faction_add_pooled_resource(key, "vmp_blood_kiss", "faction", value.amount);
			end
		end
	end
	
	for key, value in pairs(self.faction_script_context) do --Sets the AI script context at the start of the game and whenever a save is loaded
		cm:cai_set_faction_script_context(key, value.context);
		out.design("============== This faction: "..key.." is now using this context: "..cm:cai_get_faction_script_context(key)..", defining AI behaviour for faction feature ==============");
	end
	
	core:add_listener(
		"vampire_bloodlines_ritual",
		"RitualCompletedEvent",
		function(context) return context:succeeded() end,
		function(context)
			local ritual = context:ritual():ritual_key();
			
			if self.ritual_to_bloodline[ritual] ~= nil then
				local faction = context:performing_faction();
				local bloodline = self.ritual_to_bloodline[ritual];
				self:bloodline_triggered(bloodline, faction);
			end
		end,
		true
	);
	core:add_listener(
		"vampire_bloodlines_skill",
		"CharacterSkillPointAllocated",
		function(context) return context:skill_point_spent_on() == "wh2_dlc11_skill_vmp_bloodline_von_carstein_unique_cattle_herder" end,
		function(context)
			local faction = context:character():faction();
			local faction_key = faction:name();
			local unit_key = self.bloodline_details["bloodline_von_carstein"].unit_reward;
			
			cm:add_units_to_faction_mercenary_pool(faction:command_queue_index(), unit_key, 1);
			
			self.unit_caps[faction_key] = self.unit_caps[faction_key] or {};
			self.unit_caps[faction_key][unit_key] = self.unit_caps[faction_key][unit_key] or {};
			self.unit_caps[faction_key][unit_key].capacity = (self.unit_caps[faction_key][unit_key].capacity or 0) + 1;
			self.unit_caps[faction_key][unit_key].in_pool = (self.unit_caps[faction_key][unit_key].in_pool or 0) + 1;
		end,
		true
	);
	core:add_listener(
		"vampire_bloodline_unit_trained",
		"UnitTrained",
		function(context) return context:unit():unit_key() == "wh2_dlc11_vmp_inf_crossbowmen" or context:unit():unit_key() == "wh2_dlc11_vmp_inf_handgunners" end,
		function(context)
			local faction_key = context:unit():faction():name();
			local unit_key = context:unit():unit_key();
			self.unit_caps[faction_key][unit_key].in_pool = self.unit_caps[faction_key][unit_key].in_pool - 1;
		end,
		true
	);
	core:add_listener(
		"faction_leader_killed",
		"CharacterConvalescedOrKilled",
		function(context)
			return context:character():is_faction_leader();
		end,
		function(context)
			self:faction_leader_killed(context:character());
		end,
		true
	);
	core:add_listener(
		"vampire_bloodline_on_vassalage",
		"PositiveDiplomaticEvent",
		function(context) return context:is_vassalage() end,
		function(context)
			self:on_vassalage(context);
		end,
		true
	);
	core:add_listener(
		"vampire_bloodline_on_liberation_vassalage",
		"FactionBecomesLiberationVassal",
		true,
		function(context)
			self:on_liberation_vassalage(context);
		end,
		true
	);
	core:add_listener(
		"vampire_bloodline_on_assassination",
		"CharacterCharacterTargetAction",
		function(context) return context:mission_result_critial_success() or context:mission_result_success() end,
		function(context)
			self:on_assassination(context);
		end,
		true
	);
	core:add_listener(
		"vampire_bloodline_on_technology_researched",
		"ResearchCompleted",
		true,
		function(context)
			self:on_technology_researched(context);
		end,
		true
	);
	cm:add_faction_turn_start_listener_by_culture(
		"unit_respawn",
		"wh_main_vmp_vampire_counts",
		function(context) self:unit_respawn(context); end,
		true
	);
	
end

function vampire_bloodlines:bloodline_triggered(bloodline, faction)
	local faction_key = faction:name();
	out.design("BLOODLINES: bloodline_triggered - Bloodline: "..bloodline.." - Faction: "..faction_key);
	self.levels[faction_key] = self.levels[faction_key] or {};
	
	if self.bloodline_details[bloodline] ~= nil then
		out.design("\tFound bloodline");
		
		self.levels[faction_key][bloodline] = self.levels[faction_key][bloodline] or 0;
		
		-- Give unit reward if necessary
		if self.bloodline_details[bloodline].unit_reward ~= "" then
			local unit_key = self.bloodline_details[bloodline].unit_reward;
			cm:add_units_to_faction_mercenary_pool(faction:command_queue_index(), unit_key, 1);
			
			self.unit_caps[faction_key] = self.unit_caps[faction_key] or {};
			self.unit_caps[faction_key][unit_key] = self.unit_caps[faction_key][unit_key] or {};
			self.unit_caps[faction_key][unit_key].capacity = (self.unit_caps[faction_key][unit_key].capacity or 0) + 1;
			self.unit_caps[faction_key][unit_key].in_pool = (self.unit_caps[faction_key][unit_key].in_pool or 0) + 1;
		end
		-- Give final level reward if necessary
		if self.bloodline_details[bloodline].max_level_reward ~= "" then
			if self.levels[faction_key][bloodline] == 2 then
				local unit_key = self.bloodline_details[bloodline].max_level_reward;
				cm:add_units_to_faction_mercenary_pool(faction:command_queue_index(), unit_key, 1);
				
				self.unit_caps[faction_key] = self.unit_caps[faction_key] or {};
				self.unit_caps[faction_key][unit_key] = self.unit_caps[faction_key][unit_key] or {};
				self.unit_caps[faction_key][unit_key].capacity = (self.unit_caps[faction_key][unit_key].capacity or 0) + 1;
				self.unit_caps[faction_key][unit_key].in_pool = (self.unit_caps[faction_key][unit_key].in_pool or 0) + 1;
			end
		end
		
		local subtype = self.bloodline_details[bloodline].subtype;
		local artset = self.bloodline_details[bloodline].artset;
		local forename = "";
		local surname = self.bloodline_details[bloodline].forced_surname;
		
		if surname ~= "" then
			forename = self.male_forenames[cm:random_number(#self.male_forenames)]
		end;
		
		-- Add the character to the character pool
		local new_character = cm:spawn_character_to_pool(faction_key, forename, surname, "", "", 21, true, "general", subtype, false, artset);
		if not is_null(new_character) then
			out.design(string.format("\tAdded character to pool: %s, %s, %s, %s, %s.", faction_key, new_character:get_forename(), new_character:get_surname(), subtype, artset));
		else
			script_error(string.format("Failed to create new bloodline general for faction '%s' of subtype '%s'.", faction_key, subtype));
		end
		

		-- Move camera
		if not cm:get_saved_value("bloodline_first_use") then
			cm:set_saved_value("bloodline_first_use", true);
		end
		
		-- Effect Level
		local effect_key = self.bloodline_to_effects[bloodline];
		
		if self.levels[faction_key][bloodline] < 3 then
			self.levels[faction_key][bloodline] = self.levels[faction_key][bloodline] + 1;
		end
		
		if self.levels[faction_key][bloodline] == 2 then
			cm:remove_effect_bundle(effect_key..1, faction_key);
		elseif self.levels[faction_key][bloodline] == 3 then
			cm:remove_effect_bundle(effect_key..1, faction_key);
			cm:remove_effect_bundle(effect_key..2, faction_key);
		end
	end
end


function vampire_bloodlines:unit_respawn(context)
	local faction = context:faction();
	local faction_key = faction:name();
	local unit_caps = self.unit_caps[faction_key];
	
	if unit_caps ~= nil then
		for unit_key, unit_cap_table in pairs(unit_caps) do
			local current_count = self:count_unit(faction, unit_key);
			local missing = unit_cap_table.capacity - unit_cap_table.in_pool - current_count;
			out.design("BLOODLINES: "..missing.." "..unit_key.." are missing ("..unit_cap_table.capacity.." / "..unit_cap_table.in_pool.." / "..current_count..")");
			
			if missing > 0 then
				cm:add_units_to_faction_mercenary_pool(faction:command_queue_index(), unit_key, missing);
				self.unit_caps[faction_key][unit_key].in_pool = self.unit_caps[faction_key][unit_key].in_pool + 1;
			end
		end
	end
end

function vampire_bloodlines:count_unit(faction, unit_key)
	local mf_list = faction:military_force_list();
	local count = 0;
	
	for i = 0, mf_list:num_items() - 1 do
		local current_mf = mf_list:item_at(i);
		
		if current_mf:is_armed_citizenry() == false then
			local unit_list = current_mf:unit_list();
			
			for j = 0, unit_list:num_items() - 1 do
				local unit = unit_list:item_at(j);
				local key = unit:unit_key();
				
				if key == unit_key then
					count = count + 1;
				end
			end
		end
	end
	return count;
end

-- Blood Kiss from defeating Faction Leaders
function vampire_bloodlines:faction_leader_killed(character)
	local pending_battle = cm:model():pending_battle();
	
	if pending_battle:is_active() then
		local function add_faction_leader_bloodkiss(faction)
			if faction:subculture() == "wh_main_sc_vmp_vampire_counts" then
				cm:faction_add_pooled_resource(faction:name(), "vmp_blood_kiss", "faction_leaders_killed_in_battle", 1);
			end
		end
		
		local character_cqi = character:command_queue_index();
		
		if cm:pending_battle_cache_defender_victory() and pending_battle:has_defender() then
			for i = 1, cm:pending_battle_cache_num_attackers() do
				local attacker_cqi, attacker_force_cqi, attacker_name = cm:pending_battle_cache_get_attacker(i);
				
				if attacker_cqi == character_cqi then
					add_faction_leader_bloodkiss(pending_battle:defender():faction());
					break;
				end
			end
		elseif pending_battle:has_attacker() then
			for i = 1, cm:pending_battle_cache_num_defenders() do
				local defender_cqi, defender_force_cqi, defender_name = cm:pending_battle_cache_get_defender(i);
				
				if defender_cqi == character_cqi then
					add_faction_leader_bloodkiss(pending_battle:attacker():faction());
					break;
				end
			end
		end
	end
end

-- Blood Kiss from gaining a vassal
function vampire_bloodlines:on_vassalage(context)
	if context:proposer_is_vassal() == true then
		local vassal = context:proposer():name();
		
		if self.vassals[vassal] == nil then
			if context:recipient():subculture() == "wh_main_sc_vmp_vampire_counts" then
				cm:faction_add_pooled_resource(context:recipient():name(), "vmp_blood_kiss", "factions_vassalised", 1);
				self.vassals[vassal] = true;
			end
		end
	else
		local vassal = context:recipient():name();
		
		if self.vassals[vassal] == nil then
			if context:proposer():subculture() == "wh_main_sc_vmp_vampire_counts" then
				cm:faction_add_pooled_resource(context:proposer():name(), "vmp_blood_kiss", "factions_vassalised", 1);
				self.vassals[vassal] = true;
			end
		end
	end
end

function vampire_bloodlines:on_liberation_vassalage(context)
	local vassal = context:faction():name();
	
	if self.vassals[vassal] == nil then
		if context:liberating_character():faction():subculture() == "wh_main_sc_vmp_vampire_counts" then
			cm:faction_add_pooled_resource(context:liberating_character():faction():name(), "vmp_blood_kiss", "factions_vassalised", 1);
			self.vassals[vassal] = true;
		end
	end
end

-- Blood Kiss from assassination
function vampire_bloodlines:on_assassination(context)
	if self.assassination_actions[context:agent_action_key()] then
		local faction = context:character():faction();
		
		if faction:subculture() == "wh_main_sc_vmp_vampire_counts" then
			cm:faction_add_pooled_resource(faction:name(), "vmp_blood_kiss", "characters_assassinated", 1);
		end
	end
end

-- Blood Kiss from technology
function vampire_bloodlines:on_technology_researched(context)
	if self.technologies[context:technology()] then
		local faction = context:faction();
		local amount = self.technologies[context:technology()];
		
		if faction:subculture() == "wh_main_sc_vmp_vampire_counts" then
			cm:faction_add_pooled_resource(faction:name(), "vmp_blood_kiss", "other", amount);
		end	
	end
end

--------------------------------------------------------------
----------------------- SAVING / LOADING ---------------------
--------------------------------------------------------------
cm:add_saving_game_callback(
	function(context)
		cm:save_named_value("vampire_bloodlines_levels", vampire_bloodlines.levels, context);
		cm:save_named_value("vampire_bloodlines_unit_caps", vampire_bloodlines.unit_caps, context);
		cm:save_named_value("vampire_bloodlines_vassals", vampire_bloodlines.vassals, context);
	end
);

cm:add_loading_game_callback(
	function(context)
		if cm:is_new_game() == false then
			vampire_bloodlines.levels = cm:load_named_value("vampire_bloodlines_levels", vampire_bloodlines.levels, context);
			vampire_bloodlines.unit_caps = cm:load_named_value("vampire_bloodlines_unit_caps", vampire_bloodlines.unit_caps, context);
			vampire_bloodlines.vassals = cm:load_named_value("vampire_bloodlines_vassals", vampire_bloodlines.vassals, context);
		end
	end
);